<section id="screen-memory" class="screen">
  <img src="../assets/Matrix.png" alt="Matrix TSL" class="logo matrix-logo" />
  <button id="btnHome" class="home-button">üè†</button>
  
  <div class="game-container">
    <h1 class="game-title">Flappy Bird</h1>
    <div class="status-bar">
      <span id="score">Score: 0</span>
      <span id="status">Press SPACE or Click to start!</span>
    </div>
    <canvas id="game-canvas" width="500" height="600"></canvas>
    <button id="restart-btn" class="restart-btn" style="display: none;">Play Again</button>
    <div class="instructions">
      <p>üê¶ Tap or press SPACE to flap</p>
      <p>üö´ Avoid the pipes</p>
    </div>
  </div>
</section>

<style>
  /* Flappy Bird Game Styles */
  #screen-memory {
    width: 100%;
    height: 100vh;
    height: 100dvh;
    margin: 0;
    padding: 20px;
    box-sizing: border-box;
    background: linear-gradient(180deg, #87CEEB 0%, #98FB98 50%, #90EE90 100%);
    color: white;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
  }
  
  /* Floating clouds animation */
  #screen-memory::before {
    content: "";
    position: absolute;
    inset: 0;
    background:
      radial-gradient(ellipse 120px 60px at 20% 20%, rgba(255,255,255,0.4), transparent),
      radial-gradient(ellipse 80px 40px at 70% 30%, rgba(255,255,255,0.3), transparent),
      radial-gradient(ellipse 100px 50px at 50% 15%, rgba(255,255,255,0.3), transparent);
    animation: cloudDrift 30s ease-in-out infinite;
    pointer-events: none;
    z-index: 0;
  }
  
  @keyframes cloudDrift {
    0% { transform: translateX(-10%); }
    50% { transform: translateX(10%); }
    100% { transform: translateX(-10%); }
  }
  
  /* Logo and Home Button */
  #screen-memory .matrix-logo {
    position: absolute;
    top: 20px;
    left: 20px;
    height: 35px;
    width: auto;
    z-index: 10;
    opacity: 0.9;
  }
  
  #screen-memory .home-button {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 45px;
    height: 45px;
    border: none;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    color: #333;
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    z-index: 10;
  }
  
  #screen-memory .home-button:hover {
    background: rgba(255, 255, 255, 0.5);
    transform: scale(1.1);
  }
  
  /* Game Container */
  #screen-memory .game-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 15px;
    max-width: 500px;
    margin: 0 auto;
    padding-top: 60px;
    min-height: 0;
    position: relative;
    z-index: 2;
  }
  
  #screen-memory .game-title {
    font-size: clamp(24px, 4vw, 36px);
    margin: 0;
    text-align: center;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    color: #2E8B57;
    font-weight: bold;
  }
  
  #screen-memory .status-bar {
    background: rgba(255, 255, 255, 0.2);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: clamp(14px, 2.5vw, 16px);
    font-weight: 600;
    text-align: center;
    color: #2E8B57;
    display: flex;
    gap: 20px;
    align-items: center;
  }
  
  /* Game Canvas */
  #screen-memory #game-canvas {
    border: 3px solid #2E8B57;
    border-radius: 15px;
    background: linear-gradient(180deg, #87CEEB 0%, #98FB98 100%);
    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    max-width: 95vw;
    height: auto;
  }
  
  /* Restart Button */
  #screen-memory .restart-btn {
    background: #FF6347;
    border: none;
    color: white;
    padding: 12px 24px;
    border-radius: 25px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 4px 15px rgba(255, 99, 71, 0.3);
  }
  
  #screen-memory .restart-btn:hover {
    background: #FF4500;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(255, 99, 71, 0.4);
  }
  
  /* Instructions */
  #screen-memory .instructions {
    text-align: center;
    color: #2E8B57;
    font-size: clamp(12px, 2vw, 14px);
    font-weight: 500;
  }
  
  #screen-memory .instructions p {
    margin: 4px 0;
  }
  
  /* Responsive Design */
  @media (max-width: 600px) {
    #screen-memory {
      padding: 15px;
    }
    
    #screen-memory .game-container {
      gap: 12px;
      padding-top: 55px;
    }
    
    #screen-memory #game-canvas {
      width: 375px;
      height: 450px;
    }
  }
  
  @media (max-height: 700px) {
    #screen-memory .game-container {
      gap: 10px;
      padding-top: 50px;
    }
    
    #screen-memory #game-canvas {
      width: 400px;
      height: 400px;
    }
  }
  
  @media (max-height: 600px) {
    #screen-memory .game-container {
      gap: 8px;
      padding-top: 45px;
    }
    
    #screen-memory #game-canvas {
      width: 350px;
      height: 350px;
    }
  }
</style>

<script>
(function() {
  'use strict';
  
  // Game elements
  let canvas = null;
  let ctx = null;
  let scoreEl = null;
  let statusEl = null;
  let restartBtn = null;
  
  // Game state
  let gameState = 'waiting'; // 'waiting', 'playing', 'gameOver'
  let score = 0;
  let gameSpeed = 2;
  
  // Bird properties
  let bird = {
    x: 80,
    y: 200,
    width: 25,
    height: 25,
    velocity: 0,
    gravity: 0.3,
    jumpForce: -6,
    color: '#FFD700'
  };
  
  // Pipes array
  let pipes = [];
  let pipeWidth = 60;
  let pipeGap = 150;
  let pipeSpacing = 200;
  
  // Animation frame
  let animationId = null;
  
  // Initialize the game
  function init() {
    canvas = document.getElementById('game-canvas');
    ctx = canvas.getContext('2d');
    scoreEl = document.getElementById('score');
    statusEl = document.getElementById('status');
    restartBtn = document.getElementById('restart-btn');
    
    // Event listeners
    canvas.addEventListener('click', handleInput);
    document.addEventListener('keydown', handleKeyDown);
    restartBtn.addEventListener('click', resetGame);
    document.getElementById('btnHome').addEventListener('click', goHome);
    
    // Start the game loop
    resetGame();
    gameLoop();
  }
  
  function handleInput() {
    if (gameState === 'waiting') {
      startGame();
    } else if (gameState === 'playing') {
      bird.velocity = bird.jumpForce;
    }
  }
  
  function handleKeyDown(e) {
    if (e.code === 'Space') {
      e.preventDefault();
      handleInput();
    }
  }
  
  function startGame() {
    gameState = 'playing';
    bird.velocity = bird.jumpForce;
    statusEl.textContent = 'Fly little bird!';
    generatePipes();
  }
  
  function resetGame() {
    gameState = 'waiting';
    score = 0;
    gameSpeed = 2;
    
    // Reset bird
    bird.x = 80;
    bird.y = canvas.height / 2;
    bird.velocity = 0;
    
    // Clear pipes
    pipes = [];
    
    // Update UI
    updateScore();
    statusEl.textContent = 'Press SPACE or Click to start!';
    restartBtn.style.display = 'none';
  }
  
  function generatePipes() {
    pipes = [];
    for (let i = 0; i < 4; i++) {
      createPipe(canvas.width + i * pipeSpacing);
    }
  }
  
  function createPipe(x) {
    let gapY = Math.random() * (canvas.height - pipeGap - 100) + 50;
    pipes.push({
      x: x,
      topHeight: gapY,
      bottomY: gapY + pipeGap,
      bottomHeight: canvas.height - (gapY + pipeGap),
      passed: false
    });
  }
  
  function updateBird() {
    if (gameState !== 'playing') return;
    
    // Apply gravity
    bird.velocity += bird.gravity;
    bird.y += bird.velocity;
    
    // Check bounds
    if (bird.y < 0 || bird.y + bird.height > canvas.height) {
      gameOver();
    }
  }
  
  function updatePipes() {
    if (gameState !== 'playing') return;
    
    pipes.forEach((pipe, index) => {
      // Move pipe
      pipe.x -= gameSpeed;
      
      // Check if bird passed pipe for scoring
      if (!pipe.passed && pipe.x + pipeWidth < bird.x) {
        pipe.passed = true;
        score++;
        updateScore();
        
        // Increase speed slightly
        if (score % 5 === 0) {
          gameSpeed += 0.2;
        }
      }
      
      // Remove pipes that are off screen and add new ones
      if (pipe.x + pipeWidth < 0) {
        pipes.splice(index, 1);
        createPipe(pipes[pipes.length - 1].x + pipeSpacing);
      }
      
      // Check collision
      if (checkCollision(bird, pipe)) {
        gameOver();
      }
    });
  }
  
  function checkCollision(bird, pipe) {
    // Check if bird is within pipe's x bounds
    if (bird.x < pipe.x + pipeWidth && bird.x + bird.width > pipe.x) {
      // Check if bird hits top or bottom pipe
      if (bird.y < pipe.topHeight || bird.y + bird.height > pipe.bottomY) {
        return true;
      }
    }
    return false;
  }
  
  function drawBird() {
    ctx.fillStyle = bird.color;
    ctx.fillRect(bird.x, bird.y, bird.width, bird.height);
    
    // Simple bird face
    ctx.fillStyle = '#FF4500';
    ctx.fillRect(bird.x + 20, bird.y + 8, 8, 6); // beak
    ctx.fillStyle = '#000';
    ctx.fillRect(bird.x + 5, bird.y + 5, 3, 3); // eye
  }
  
  function drawPipes() {
    ctx.fillStyle = '#228B22';
    pipes.forEach(pipe => {
      // Top pipe
      ctx.fillRect(pipe.x, 0, pipeWidth, pipe.topHeight);
      // Bottom pipe  
      ctx.fillRect(pipe.x, pipe.bottomY, pipeWidth, pipe.bottomHeight);
      
      // Pipe caps
      ctx.fillStyle = '#32CD32';
      ctx.fillRect(pipe.x - 5, pipe.topHeight - 20, pipeWidth + 10, 20);
      ctx.fillRect(pipe.x - 5, pipe.bottomY, pipeWidth + 10, 20);
      ctx.fillStyle = '#228B22';
    });
  }
  
  function drawBackground() {
    // Sky gradient
    let gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
    gradient.addColorStop(0, '#87CEEB');
    gradient.addColorStop(1, '#98FB98');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Simple clouds
    ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
    ctx.beginPath();
    ctx.arc(100, 80, 20, 0, Math.PI * 2);
    ctx.arc(120, 80, 25, 0, Math.PI * 2);
    ctx.arc(140, 80, 20, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.beginPath();
    ctx.arc(300, 120, 15, 0, Math.PI * 2);
    ctx.arc(315, 120, 20, 0, Math.PI * 2);
    ctx.arc(330, 120, 15, 0, Math.PI * 2);
    ctx.fill();
  }
  
  function render() {
    // Clear canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Draw game elements
    drawBackground();
    drawPipes();
    drawBird();
  }
  
  function gameLoop() {
    updateBird();
    updatePipes();
    render();
    
    animationId = requestAnimationFrame(gameLoop);
  }
  
  function gameOver() {
    gameState = 'gameOver';
    statusEl.textContent = 'üí• Game Over!';
    restartBtn.style.display = 'block';
    
    if (animationId) {
      cancelAnimationFrame(animationId);
    }
  }
  
  function updateScore() {
    scoreEl.textContent = `Score: ${score}`;
  }
  
  function goHome() {
    if (animationId) {
      cancelAnimationFrame(animationId);
    }
    
    if (window.showcaseFramework && window.showcaseFramework.goHome) {
      window.showcaseFramework.goHome();
    } else {
      window.location.href = '../index.html';
    }
  }
  
  // Lifecycle management
  window.appLifecycle = {
    activate: function() {
      console.log('Flappy Bird activated');
      if (!animationId) {
        gameLoop();
      }
    },
    
    deactivate: function() {
      console.log('Flappy Bird deactivated');
      if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
      }
    },
    
    cleanup: function() {
      console.log('Flappy Bird cleanup');
      if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
      }
    }
  };
  
  // Start the game when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>