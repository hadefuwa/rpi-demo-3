<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AR5 - Modular 3D Classroom Builder</title>
  <style>
    :root {
      --primary: #4f46e5;
      --secondary: #7c3aed;
      --accent: #06b6d4;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --dark: #0f172a;
      --darker: #020617;
      --light: #f8fafc;
      --muted: #64748b;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    html, body {
      height: 100%;
      background: var(--darker);
      color: var(--light);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow: hidden;
    }
    
    .app {
      position: fixed;
      inset: 0;
      display: grid;
      grid-template-columns: 300px 1fr;
      grid-template-rows: 60px 1fr;
    }
    
    .header {
      grid-column: 1 / -1;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 1000;
    }
    
    .header h1 {
      font-size: 1.5rem;
      font-weight: 600;
    }
    
    .header-controls {
      display: flex;
      gap: 10px;
    }
    
    .sidebar {
      background: var(--dark);
      border-right: 1px solid rgba(255,255,255,0.1);
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .main-view {
      position: relative;
      background: var(--darker);
    }
    
    .panel {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 16px;
    }
    
    .panel h3 {
      margin-bottom: 12px;
      color: var(--accent);
      font-size: 1rem;
      font-weight: 600;
    }
    
    .component-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .component-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      padding: 12px 8px;
      color: var(--light);
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.8rem;
      text-align: center;
    }
    
    .component-btn:hover {
      background: rgba(255,255,255,0.2);
      border-color: var(--accent);
      transform: translateY(-1px);
    }
    
    .component-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: var(--darker);
    }
    
    .control-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .control-group label {
      font-size: 0.8rem;
      color: var(--muted);
    }
    
    .control-group input, .control-group select {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 6px;
      padding: 8px 12px;
      color: var(--light);
      font-size: 0.9rem;
    }
    
    .control-group input:focus, .control-group select:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .btn {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .btn:hover {
      background: var(--secondary);
      transform: translateY(-1px);
    }
    
    .btn.secondary {
      background: rgba(255,255,255,0.1);
      color: var(--light);
    }
    
    .btn.secondary:hover {
      background: rgba(255,255,255,0.2);
    }
    
    .btn.danger {
      background: var(--error);
    }
    
    .btn.danger:hover {
      background: #dc2626;
    }
    
    .btn-group {
      display: flex;
      gap: 8px;
    }
    
    .status-bar {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(0,0,0,0.8);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 0.9rem;
      color: var(--light);
      z-index: 100;
    }
    
    .status-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
    }
    
    .status-dot.warning { background: var(--warning); }
    .status-dot.error { background: var(--error); }
    
    .tooltip {
      position: absolute;
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      pointer-events: none;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .tooltip.show {
      opacity: 1;
    }
    
    #three-canvas {
      width: 100%;
      height: 100%;
      display: block;
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <h1>üéì AR5 - Modular Classroom Builder</h1>
      <div class="header-controls">
        <button class="btn" id="resetScene">Reset Scene</button>
        <button class="btn" id="exportScene">Export</button>
        <button class="btn secondary" id="helpBtn">Help</button>
      </div>
    </header>
    
    <aside class="sidebar">
      <div class="panel">
        <h3>üèóÔ∏è Components</h3>
        <div class="component-grid">
          <button class="component-btn" data-component="wall">Wall</button>
          <button class="component-btn" data-component="floor">Floor</button>
          <button class="component-btn" data-component="desk">Desk</button>
          <button class="component-btn" data-component="chair">Chair</button>
          <button class="component-btn" data-component="board">Board</button>
          <button class="component-btn" data-component="window">Window</button>
          <button class="component-btn" data-component="door">Door</button>
          <button class="component-btn" data-component="light">Light</button>
        </div>
        <div class="control-group">
          <label>Selected Component:</label>
          <select id="componentSelect">
            <option value="">None</option>
          </select>
        </div>
      </div>
      
      <div class="panel">
        <h3>‚öôÔ∏è Properties</h3>
        <div class="control-group">
          <label>Size X:</label>
          <input type="range" id="sizeX" min="0.5" max="10" step="0.1" value="1">
          <span id="sizeXValue">1.0</span>
        </div>
        <div class="control-group">
          <label>Size Y:</label>
          <input type="range" id="sizeY" min="0.5" max="10" step="0.1" value="1">
          <span id="sizeYValue">1.0</span>
        </div>
        <div class="control-group">
          <label>Size Z:</label>
          <input type="range" id="sizeZ" min="0.5" max="10" step="0.1" value="1">
          <span id="sizeZValue">1.0</span>
        </div>
        <div class="control-group">
          <label>Color:</label>
          <input type="color" id="colorPicker" value="#4f46e5">
        </div>
        <div class="control-group">
          <label>Material:</label>
          <select id="materialSelect">
            <option value="standard">Standard</option>
            <option value="metal">Metal</option>
            <option value="wood">Wood</option>
            <option value="glass">Glass</option>
            <option value="plastic">Plastic</option>
          </select>
        </div>
      </div>
      
      <div class="panel">
        <h3>üéØ Placement</h3>
        <div class="control-group">
          <label>Grid Snap:</label>
          <input type="checkbox" id="gridSnap" checked>
        </div>
        <div class="control-group">
          <label>Grid Size:</label>
          <input type="range" id="gridSize" min="0.1" max="2" step="0.1" value="0.5">
          <span id="gridSizeValue">0.5</span>
        </div>
        <div class="btn-group">
          <button class="btn secondary" id="deleteBtn">Delete</button>
          <button class="btn secondary" id="duplicateBtn">Duplicate</button>
        </div>
      </div>
      
      <div class="panel">
        <h3>üí° Lighting</h3>
        <div class="control-group">
          <label>Ambient Intensity:</label>
          <input type="range" id="ambientIntensity" min="0" max="2" step="0.1" value="0.4">
          <span id="ambientIntensityValue">0.4</span>
        </div>
        <div class="control-group">
          <label>Directional Intensity:</label>
          <input type="range" id="directionalIntensity" min="0" max="3" step="0.1" value="1.0">
          <span id="directionalIntensityValue">1.0</span>
        </div>
        <div class="btn-group">
          <button class="btn secondary" id="addLightBtn">Add Light</button>
          <button class="btn secondary" id="resetLightsBtn">Reset</button>
        </div>
      </div>
    </aside>
    
    <main class="main-view">
      <canvas id="three-canvas"></canvas>
      
      <div class="status-bar">
        <div class="status-item">
          <div class="status-dot"></div>
          <span>Scene Ready</span>
        </div>
        <div class="status-item">
          <div class="status-dot"></div>
          <span>Objects: <span id="objectCount">0</span></span>
        </div>
        <div class="status-item">
          <div class="status-dot"></div>
          <span>FPS: <span id="fps">60</span></span>
        </div>
      </div>
    </main>
  </div>
  
  <div class="tooltip" id="tooltip"></div>

  <script src="../js/three/three.standalone.js"></script>
  <script src="../js/three/OrbitControls.js"></script>
  
  <script>
    // ===== GLOBAL STATE =====
    let scene, camera, renderer, controls;
    let selectedComponent = null;
    let selectedObject = null;
    let isPlacing = false;
    let gridHelper;
    let raycaster = new THREE.Raycaster();
    let mouse = new THREE.Vector2();
    let clock = new THREE.Clock();
    let frameCount = 0;
    let lastTime = 0;
    
    // ===== MATERIAL LIBRARY =====
    const materials = {
      standard: new THREE.MeshStandardMaterial({ color: 0x4f46e5, roughness: 0.5, metalness: 0.0 }),
      metal: new THREE.MeshStandardMaterial({ color: 0x8ea1b5, roughness: 0.3, metalness: 0.8 }),
      wood: new THREE.MeshStandardMaterial({ color: 0x9a6a3a, roughness: 0.8, metalness: 0.0 }),
      glass: new THREE.MeshPhysicalMaterial({ 
        color: 0xaed1ff, 
        roughness: 0.1, 
        transmission: 0.9, 
        thickness: 0.2, 
        transparent: true 
      }),
      plastic: new THREE.MeshStandardMaterial({ color: 0x3a8ad8, roughness: 0.6, metalness: 0.0 })
    };
    
    // ===== COMPONENT DEFINITIONS =====
    const componentDefinitions = {
      wall: {
        name: 'Wall',
        geometry: 'box',
        defaultSize: [4, 3, 0.2],
        defaultMaterial: 'standard',
        defaultColor: '#e7ebf0'
      },
      floor: {
        name: 'Floor',
        geometry: 'box',
        defaultSize: [8, 0.2, 6],
        defaultMaterial: 'standard',
        defaultColor: '#3c434d'
      },
      desk: {
        name: 'Desk',
        geometry: 'box',
        defaultSize: [1.2, 0.8, 0.7],
        defaultMaterial: 'wood',
        defaultColor: '#9a6a3a'
      },
      chair: {
        name: 'Chair',
        geometry: 'box',
        defaultSize: [0.6, 0.5, 0.5],
        defaultMaterial: 'plastic',
        defaultColor: '#3a8ad8'
      },
      board: {
        name: 'Board',
        geometry: 'box',
        defaultSize: [3, 1.5, 0.1],
        defaultMaterial: 'standard',
        defaultColor: '#0b1f2a'
      },
      window: {
        name: 'Window',
        geometry: 'box',
        defaultSize: [2, 1.5, 0.1],
        defaultMaterial: 'glass',
        defaultColor: '#aed1ff'
      },
      door: {
        name: 'Door',
        geometry: 'box',
        defaultSize: [1, 2.2, 0.1],
        defaultMaterial: 'wood',
        defaultColor: '#9a6a3a'
      },
      light: {
        name: 'Light',
        geometry: 'sphere',
        defaultSize: [0.3, 0.3, 0.3],
        defaultMaterial: 'metal',
        defaultColor: '#fbbf24'
      }
    };
    
    // ===== INITIALIZATION =====
    function init() {
      initThreeJS();
      initUI();
      initEventListeners();
      createDefaultScene();
      animate();
    }
    
    function initThreeJS() {
      // Scene
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x0a0a0a);
      
      // Camera
      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.set(10, 8, 10);
      
      // Renderer
      renderer = new THREE.WebGLRenderer({ 
        canvas: document.getElementById('three-canvas'),
        antialias: true,
        alpha: true
      });
      renderer.setSize(window.innerWidth - 300, window.innerHeight - 60);
      renderer.shadowMap.enabled = true;
      renderer.shadowMap.type = THREE.PCFSoftShadowMap;
      
      // Controls
      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      controls.maxPolarAngle = Math.PI / 2;
      
      // Grid
      gridHelper = new THREE.GridHelper(20, 40, 0x444444, 0x222222);
      scene.add(gridHelper);
      
      // Lights
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
      scene.add(ambientLight);
      
      const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
      directionalLight.position.set(10, 10, 5);
      directionalLight.castShadow = true;
      directionalLight.shadow.mapSize.width = 2048;
      directionalLight.shadow.mapSize.height = 2048;
      directionalLight.shadow.camera.near = 0.5;
      directionalLight.shadow.camera.far = 50;
      directionalLight.shadow.camera.left = -10;
      directionalLight.shadow.camera.right = 10;
      directionalLight.shadow.camera.top = 10;
      directionalLight.shadow.camera.bottom = -10;
      scene.add(directionalLight);
    }
    
    function initUI() {
      // Component buttons
      document.querySelectorAll('.component-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.component-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          selectedComponent = btn.dataset.component;
          updateComponentSelect();
        });
      });
      
      // Size controls
      ['sizeX', 'sizeY', 'sizeZ'].forEach(axis => {
        const slider = document.getElementById(axis);
        const value = document.getElementById(axis + 'Value');
        slider.addEventListener('input', (e) => {
          value.textContent = parseFloat(e.target.value).toFixed(1);
          if (selectedObject) {
            updateObjectSize(selectedObject, axis, parseFloat(e.target.value));
          }
        });
      });
      
      // Color picker
      document.getElementById('colorPicker').addEventListener('change', (e) => {
        if (selectedObject) {
          updateObjectColor(selectedObject, e.target.value);
        }
      });
      
      // Material selector
      document.getElementById('materialSelect').addEventListener('change', (e) => {
        if (selectedObject) {
          updateObjectMaterial(selectedObject, e.target.value);
        }
      });
      
      // Grid controls
      document.getElementById('gridSnap').addEventListener('change', (e) => {
        // Grid snap logic
      });
      
      document.getElementById('gridSize').addEventListener('input', (e) => {
        const size = parseFloat(e.target.value);
        document.getElementById('gridSizeValue').textContent = size.toFixed(1);
        updateGrid(size);
      });
      
      // Lighting controls
      document.getElementById('ambientIntensity').addEventListener('input', (e) => {
        const intensity = parseFloat(e.target.value);
        document.getElementById('ambientIntensityValue').textContent = intensity.toFixed(1);
        updateAmbientLight(intensity);
      });
      
      document.getElementById('directionalIntensity').addEventListener('input', (e) => {
        const intensity = parseFloat(e.target.value);
        document.getElementById('directionalIntensityValue').textContent = intensity.toFixed(1);
        updateDirectionalLight(intensity);
      });
      
      // Action buttons
      document.getElementById('resetScene').addEventListener('click', resetScene);
      document.getElementById('exportScene').addEventListener('click', exportScene);
      document.getElementById('deleteBtn').addEventListener('click', deleteSelected);
      document.getElementById('duplicateBtn').addEventListener('click', duplicateSelected);
      document.getElementById('addLightBtn').addEventListener('click', addLight);
      document.getElementById('resetLightsBtn').addEventListener('click', resetLights);
    }
    
    function initEventListeners() {
      // Mouse events
      renderer.domElement.addEventListener('mousedown', onMouseDown);
      renderer.domElement.addEventListener('mousemove', onMouseMove);
      renderer.domElement.addEventListener('click', onClick);
      
      // Keyboard events
      document.addEventListener('keydown', onKeyDown);
      
      // Window resize
      window.addEventListener('resize', onWindowResize);
    }
    
    // ===== SCENE MANAGEMENT =====
    function createDefaultScene() {
      // Create a basic classroom structure
      createComponent('floor', 0, 0, 0);
      createComponent('wall', 0, 1.5, -3);
      createComponent('wall', 0, 1.5, 3);
      createComponent('wall', -4, 1.5, 0);
      createComponent('wall', 4, 1.5, 0);
      
      // Add some furniture
      createComponent('board', 0, 1.5, -2.9);
      createComponent('desk', 0, 0.4, -2);
      createComponent('chair', 0, 0.25, -1.2);
      
      // Add a few student desks
      for (let i = 0; i < 3; i++) {
        for (let j = 0; j < 2; j++) {
          const x = (i - 1) * 2;
          const z = j * 2;
          createComponent('desk', x, 0.4, z);
          createComponent('chair', x, 0.25, z - 0.6);
        }
      }
      
      updateObjectCount();
    }
    
    function createComponent(type, x, y, z) {
      if (!componentDefinitions[type]) return null;
      
      const def = componentDefinitions[type];
      let geometry;
      
      if (def.geometry === 'box') {
        geometry = new THREE.BoxGeometry(...def.defaultSize);
      } else if (def.geometry === 'sphere') {
        geometry = new THREE.SphereGeometry(def.defaultSize[0] / 2, 16, 16);
      }
      
      const material = materials[def.defaultMaterial].clone();
      material.color.setHex(parseInt(def.defaultColor.replace('#', '0x')));
      
      const mesh = new THREE.Mesh(geometry, material);
      mesh.position.set(x, y, z);
      mesh.castShadow = true;
      mesh.receiveShadow = true;
      mesh.userData = {
        type: type,
        componentType: type,
        originalSize: [...def.defaultSize],
        material: def.defaultMaterial
      };
      
      scene.add(mesh);
      return mesh;
    }
    
    // ===== INTERACTION HANDLERS =====
    function onMouseDown(event) {
      if (selectedComponent && !isPlacing) {
        isPlacing = true;
        startPlacement(event);
      }
    }
    
    function onMouseMove(event) {
      if (isPlacing) {
        updatePlacement(event);
      }
      
      // Update tooltip
      updateTooltip(event);
    }
    
    function onClick(event) {
      if (isPlacing) {
        finishPlacement(event);
        return;
      }
      
      // Select object
      selectObject(event);
    }
    
    function onKeyDown(event) {
      switch(event.key) {
        case 'Escape':
          cancelPlacement();
          break;
        case 'Delete':
          deleteSelected();
          break;
        case 'd':
          if (event.ctrlKey) duplicateSelected();
          break;
      }
    }
    
    // ===== PLACEMENT SYSTEM =====
    function startPlacement(event) {
      // Create preview object
      const preview = createComponent(selectedComponent, 0, 0, 0);
      preview.material.transparent = true;
      preview.material.opacity = 0.6;
      preview.userData.isPreview = true;
      
      scene.add(preview);
      selectedObject = preview;
    }
    
    function updatePlacement(event) {
      if (!selectedObject || !selectedObject.userData.isPreview) return;
      
      const intersects = getMouseIntersects(event);
      if (intersects.length > 0) {
        const point = intersects[0].point;
        const gridSize = parseFloat(document.getElementById('gridSize').value);
        
        // Snap to grid
        if (document.getElementById('gridSnap').checked) {
          point.x = Math.round(point.x / gridSize) * gridSize;
          point.y = Math.round(point.y / gridSize) * gridSize;
          point.z = Math.round(point.z / gridSize) * gridSize;
        }
        
        selectedObject.position.copy(point);
      }
    }
    
    function finishPlacement(event) {
      if (!selectedObject || !selectedObject.userData.isPreview) return;
      
      // Remove preview properties
      selectedObject.material.transparent = false;
      selectedObject.material.opacity = 1.0;
      delete selectedObject.userData.isPreview;
      
      // Finalize placement
      isPlacing = false;
      selectedObject = null;
      updateObjectCount();
    }
    
    function cancelPlacement() {
      if (selectedObject && selectedObject.userData.isPreview) {
        scene.remove(selectedObject);
        selectedObject = null;
      }
      isPlacing = false;
    }
    
    // ===== UTILITY FUNCTIONS =====
    function getMouseIntersects(event) {
      const rect = renderer.domElement.getBoundingClientRect();
      mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
      mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
      
      raycaster.setFromCamera(mouse, camera);
      return raycaster.intersectObjects(scene.children.filter(obj => obj !== gridHelper));
    }
    
    function selectObject(event) {
      const intersects = getMouseIntersects(event);
      if (intersects.length > 0) {
        const object = intersects[0].object;
        if (object.userData.isPreview) return;
        
        selectObject(object);
      } else {
        deselectObject();
      }
    }
    
    function selectObject(object) {
      if (selectedObject) {
        selectedObject.material.emissive.setHex(0x000000);
      }
      
      selectedObject = object;
      selectedObject.material.emissive.setHex(0x333333);
      
      // Update UI
      updateComponentSelect();
      updatePropertyControls();
    }
    
    function deselectObject() {
      if (selectedObject) {
        selectedObject.material.emissive.setHex(0x000000);
        selectedObject = null;
      }
      updateComponentSelect();
      updatePropertyControls();
    }
    
    function updateComponentSelect() {
      const select = document.getElementById('componentSelect');
      select.innerHTML = '<option value="">None</option>';
      
      if (selectedObject) {
        const option = document.createElement('option');
        option.value = selectedObject.userData.componentType;
        option.textContent = selectedObject.userData.componentType;
        select.appendChild(option);
        select.value = selectedObject.userData.componentType;
      }
    }
    
    function updatePropertyControls() {
      if (!selectedObject) return;
      
      // Update size controls
      document.getElementById('sizeX').value = selectedObject.scale.x;
      document.getElementById('sizeXValue').textContent = selectedObject.scale.x.toFixed(1);
      document.getElementById('sizeY').value = selectedObject.scale.y;
      document.getElementById('sizeYValue').textContent = selectedObject.scale.y.toFixed(1);
      document.getElementById('sizeZ').value = selectedObject.scale.z;
      document.getElementById('sizeZValue').textContent = selectedObject.scale.z.toFixed(1);
      
      // Update color picker
      document.getElementById('colorPicker').value = '#' + selectedObject.material.color.getHexString();
      
      // Update material selector
      document.getElementById('materialSelect').value = selectedObject.userData.material;
    }
    
    function updateObjectSize(object, axis, value) {
      if (!object) return;
      
      const scale = axis === 'sizeX' ? 'x' : axis === 'sizeY' ? 'y' : 'z';
      object.scale[scale] = value;
    }
    
    function updateObjectColor(object, color) {
      if (!object) return;
      object.material.color.setHex(parseInt(color.replace('#', '0x')));
    }
    
    function updateObjectMaterial(object, materialType) {
      if (!object || !materials[materialType]) return;
      
      const newMaterial = materials[materialType].clone();
      newMaterial.color.copy(object.material.color);
      object.material = newMaterial;
      object.userData.material = materialType;
    }
    
    function updateGrid(size) {
      scene.remove(gridHelper);
      gridHelper = new THREE.GridHelper(20, 20 / size, 0x444444, 0x222222);
      scene.add(gridHelper);
    }
    
    function updateAmbientLight(intensity) {
      scene.children.forEach(child => {
        if (child instanceof THREE.AmbientLight) {
          child.intensity = intensity;
        }
      });
    }
    
    function updateDirectionalLight(intensity) {
      scene.children.forEach(child => {
        if (child instanceof THREE.DirectionalLight) {
          child.intensity = intensity;
        }
      });
    }
    
    function updateObjectCount() {
      const count = scene.children.filter(obj => obj.type === 'Mesh' && !obj.userData.isPreview).length;
      document.getElementById('objectCount').textContent = count;
    }
    
    function updateTooltip(event) {
      const tooltip = document.getElementById('tooltip');
      const intersects = getMouseIntersects(event);
      
      if (intersects.length > 0 && !intersects[0].object.userData.isPreview) {
        const object = intersects[0].object;
        tooltip.textContent = `${object.userData.componentType || 'Object'} (${object.position.x.toFixed(1)}, ${object.position.y.toFixed(1)}, ${object.position.z.toFixed(1)})`;
        tooltip.style.left = event.clientX + 10 + 'px';
        tooltip.style.top = event.clientY - 10 + 'px';
        tooltip.classList.add('show');
      } else {
        tooltip.classList.remove('show');
      }
    }
    
    // ===== ACTION FUNCTIONS =====
    function deleteSelected() {
      if (selectedObject && !selectedObject.userData.isPreview) {
        scene.remove(selectedObject);
        selectedObject = null;
        updateObjectCount();
        updateComponentSelect();
        updatePropertyControls();
      }
    }
    
    function duplicateSelected() {
      if (selectedObject && !selectedObject.userData.isPreview) {
        const clone = selectedObject.clone();
        clone.position.add(new THREE.Vector3(1, 0, 1));
        clone.material = selectedObject.material.clone();
        clone.userData = { ...selectedObject.userData };
        scene.add(clone);
        updateObjectCount();
      }
    }
    
    function addLight() {
      const light = new THREE.PointLight(0xffffff, 1, 10);
      light.position.set(0, 5, 0);
      light.castShadow = true;
      light.userData = { type: 'light', componentType: 'light' };
      scene.add(light);
      updateObjectCount();
    }
    
    function resetLights() {
      scene.children.forEach(child => {
        if (child instanceof THREE.Light && child.type !== 'AmbientLight' && child.type !== 'DirectionalLight') {
          scene.remove(child);
        }
      });
      updateObjectCount();
    }
    
    function resetScene() {
      if (confirm('Are you sure you want to reset the scene? This will remove all objects.')) {
        scene.children.forEach(child => {
          if (child.type === 'Mesh' || (child.type === 'Light' && child.type !== 'AmbientLight' && child.type !== 'DirectionalLight')) {
            scene.remove(child);
          }
        });
        createDefaultScene();
        deselectObject();
      }
    }
    
    function exportScene() {
      const sceneData = {
        objects: [],
        lights: [],
        camera: {
          position: camera.position.toArray(),
          target: controls.target.toArray()
        }
      };
      
      scene.children.forEach(child => {
        if (child.type === 'Mesh' && !child.userData.isPreview) {
          sceneData.objects.push({
            type: child.userData.componentType,
            position: child.position.toArray(),
            scale: child.scale.toArray(),
            rotation: child.rotation.toArray(),
            material: child.userData.material,
            color: '#' + child.material.color.getHexString()
          });
        } else if (child.type === 'Light' && child.type !== 'AmbientLight' && child.type !== 'DirectionalLight') {
          sceneData.lights.push({
            type: child.type,
            position: child.position.toArray(),
            intensity: child.intensity
          });
        }
      });
      
      const dataStr = JSON.stringify(sceneData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = 'classroom-scene.json';
      link.click();
      
      URL.revokeObjectURL(url);
    }
    
    // ===== ANIMATION =====
    function animate() {
      requestAnimationFrame(animate);
      
      const time = clock.getElapsedTime();
      frameCount++;
      
      // Update FPS counter every second
      if (time - lastTime >= 1) {
        document.getElementById('fps').textContent = frameCount;
        frameCount = 0;
        lastTime = time;
      }
      
      controls.update();
      renderer.render(scene, camera);
    }
    
    function onWindowResize() {
      camera.aspect = (window.innerWidth - 300) / (window.innerHeight - 60);
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth - 300, window.innerHeight - 60);
    }
    
    // ===== HELP SYSTEM =====
    document.getElementById('helpBtn').addEventListener('click', () => {
      alert(`AR5 Classroom Builder Help:

üèóÔ∏è COMPONENTS:
‚Ä¢ Click any component button to start placing
‚Ä¢ Click in the 3D view to place the component
‚Ä¢ Press ESC to cancel placement

‚öôÔ∏è PROPERTIES:
‚Ä¢ Select an object to modify its properties
‚Ä¢ Use sliders to adjust size
‚Ä¢ Change color and material type

üéØ PLACEMENT:
‚Ä¢ Enable grid snap for precise positioning
‚Ä¢ Adjust grid size for different precision
‚Ä¢ Use mouse to orbit, scroll to zoom

‚å®Ô∏è KEYBOARD:
‚Ä¢ ESC: Cancel placement
‚Ä¢ Delete: Delete selected object
‚Ä¢ Ctrl+D: Duplicate selected object

üí° TIPS:
‚Ä¢ Start with walls and floor
‚Ä¢ Add furniture systematically
‚Ä¢ Use lighting to enhance the scene
‚Ä¢ Export your scene when done!`);
    });
    
    // ===== STARTUP =====
    init();
  </script>
</body>
</html>
