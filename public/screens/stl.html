<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>3D Model Viewer</title>
  <link rel="stylesheet" href="../styles/base.css">
  <link rel="stylesheet" href="../styles/stl.css">
  
  <!-- Simple initialization -->
  <script>
    // Simple quality mode - just use low quality for RPi compatibility
    window.QUALITY_MODE = 'low';
    console.log('STL Viewer initialized in low quality mode for reliability');
    
    // Detect touch device and set cursor visibility
    function detectTouchDevice() {
      const isTouchDevice = (
        ('ontouchstart' in window) ||
        (navigator.maxTouchPoints > 0) ||
        (navigator.msMaxTouchPoints > 0) ||
        (window.matchMedia && window.matchMedia('(pointer: coarse)').matches)
      );
      
      if (isTouchDevice) {
        document.body.classList.add('touch-device');
        console.log('Touch device detected - cursor hidden');
      } else {
        document.body.classList.remove('touch-device');
        console.log('Non-touch device detected - cursor visible');
      }
    }
    
    // Run detection immediately and on resize
    detectTouchDevice();
    window.addEventListener('resize', detectTouchDevice);
  </script>
  
  <style>
    /* STL Viewer Custom Styles */
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      touch-action: none; /* Prevent default touch behaviors */
    }
    
    /* Default cursor visibility - show cursor */
    * {
      cursor: auto !important;
    }
    
    /* Hide cursor on touch devices */
    body.touch-device * {
      cursor: none !important;
    }
    
    /* Ensure interactive elements still show pointer on non-touch */
    body:not(.touch-device) .chip,
    body:not(.touch-device) button {
      cursor: pointer !important;
    }
    
    /* Header styling */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 20px;
      background: #f8f9fa;
      color: #333;
      border-bottom: 2px solid #e9ecef;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      position: relative;
      z-index: 1000;
    }
    
    .topbar .title {
      font-size: 1.2rem;
      margin: 0;
    }
    
    .model-selector {
      display: flex;
      gap: 8px;
      flex: 1;
      justify-content: center;
    }
    
    .model-selector .chip {
      padding: 8px 16px;
      background: #fff;
      border: 2px solid #dee2e6;
      color: #495057;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
    }
    
    .model-selector .chip:hover {
      background: #e9ecef;
      border-color: #adb5bd;
      transform: translateY(-1px);
    }
    
    .model-selector .chip.active {
      background: #007bff;
      border-color: #007bff;
      color: white;
    }
    
    /* Prevent zoom on entire page */
    #app {
      touch-action: pan-x pan-y;
      overflow: hidden;
      height: 100vh;
      width: 100vw;
    }
    
    /* Canvas container - allow 3D interactions only */
    .stl-wrap {
      position: relative;
      width: 100%;
      height: calc(100vh - 80px); /* Reduced from 120px to expand canvas */
      touch-action: none; /* Allow Three.js to handle all touch events */
    }
    
    #stlCanvas {
      width: 100% !important;
      height: 100% !important;
      display: block;
      touch-action: none; /* Critical for proper 3D interaction */
    }
    
    /* Loading indicator */
    .loading-indicator {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 20px;
      border-radius: 10px;
      z-index: 100;
    }
    
    /* Simplified controls */
    .stl-controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      background: rgba(248, 249, 250, 0.95);
      padding: 10px;
      border-radius: 25px;
      border: 2px solid #dee2e6;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      z-index: 10;
    }
    
    .stl-controls .chip {
      padding: 10px 15px;
      background: #fff;
      border: 2px solid #dee2e6;
      color: #495057;
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      touch-action: manipulation;
      font-weight: 500;
    }
    
    .stl-controls .chip:hover {
      background: #e9ecef;
      border-color: #adb5bd;
      transform: translateY(-1px);
    }
    
    .stl-controls .chip.active {
      background: #28a745;
      border-color: #28a745;
      color: white;
    }
    
    .note {
      text-align: center;
      color: #6c757d;
      font-size: 0.9rem;
      padding: 10px;
      background: #f8f9fa;
      border-bottom: 1px solid #dee2e6;
      font-weight: 500;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .topbar {
        flex-direction: column;
        gap: 10px;
        padding: 10px;
      }
      
      .model-selector {
        order: 2;
      }
      
      .topbar .title {
        order: 1;
        font-size: 1rem;
      }
      
      #btnHome {
        order: 3;
        background: #dc3545;
        border-color: #dc3545;
        color: white;
      }
      
      #btnHome:hover {
        background: #c82333;
        border-color: #bd2130;
      }
      
      .stl-wrap {
        height: calc(100vh - 120px); /* Reduced padding for mobile */
      }
      
      .stl-controls {
        bottom: 10px;
        gap: 5px;
        padding: 8px;
      }
      
      .stl-controls .chip {
        padding: 8px 12px;
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <header class="topbar">
      <h1 class="title">3D Model Viewer</h1>
      <div class="model-selector">
        <button class="chip model-btn active" data-model="cad1.stl">CAD 1</button>
        <button class="chip model-btn" data-model="cad2.stl">CAD 2</button>
        <button class="chip model-btn" data-model="cad3.stl">CAD 3</button>
      </div>
      <button id="btnHome" class="chip">Home</button>
    </header>
    
    <main>
      <section id="screen-stl" class="screen active">
        <div class="container" style="padding: 0; margin: 0;">
          <div class="panel" style="padding: var(--spacing-xs); margin: 0;">
            <div class="note">Drag to rotate • Scroll to zoom</div>
            
            <div class="stl-wrap">
              <canvas id="stlCanvas"></canvas>
              <div id="loadingIndicator" class="loading-indicator">Loading 3D model...</div>
              
              <div class="stl-controls">
                <button id="btnStlZoomIn" class="chip big">＋</button>
                <button id="btnStlAuto" class="chip big">Auto</button>
                <button id="btnStlReset" class="chip big">Reset</button>
                <button id="btnStlZoomOut" class="chip big">－</button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>



<script>
  (function() {
    'use strict';
    
    let scene, camera, renderer, controls;
    let currentModel = null;
    let autoRotate = false;
    
    // Simple script loading
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = () => reject(new Error(`Failed to load ${src}`));
        document.head.appendChild(script);
      });
    }
    
    // Load dependencies with simple fallback
    async function loadDependencies() {
      try {
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js');
        await loadScript('https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js');
        await loadScript('https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js');
        console.log('Three.js loaded successfully');
        initApp();
      } catch (error) {
        console.error('Failed to load Three.js:', error);
        document.getElementById('loadingIndicator').textContent = 'Failed to load 3D libraries. Please refresh.';
      }
    }
    
    function initApp() {
      setupThreeJS();
      setupEventListeners();
      loadModel('cad1.stl');
    }
    
    function setupThreeJS() {
      const canvas = document.getElementById('stlCanvas');
      
      // Scene
      scene = new THREE.Scene();
      
      // Camera
      camera = new THREE.PerspectiveCamera(75, canvas.offsetWidth / canvas.offsetHeight, 0.1, 1000);
      camera.position.set(0, 0, 2.5); // Doubled zoom (halved distance)
      
      // Simple renderer setup
      renderer = new THREE.WebGLRenderer({
        canvas: canvas,
        alpha: true,
        antialias: false
      });
      
      renderer.setSize(canvas.offsetWidth, canvas.offsetHeight);
      renderer.setClearColor(0x87CEEB, 1); // Sky blue background for classroom
      
      // Controls
      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.1;
      
      // Enhanced lighting for better STL visibility
      const ambientLight = new THREE.AmbientLight(0xffffff, 1.2); // Brighter ambient light
      scene.add(ambientLight);
      
      // Main directional light (classroom overhead lighting)
      const directionalLight1 = new THREE.DirectionalLight(0xffffff, 1.5);
      directionalLight1.position.set(10, 15, 5);
      directionalLight1.castShadow = false; // Disable shadows for performance
      scene.add(directionalLight1);
      
      // Secondary directional light from different angle
      const directionalLight2 = new THREE.DirectionalLight(0xffffff, 1.0);
      directionalLight2.position.set(-10, 10, -5);
      scene.add(directionalLight2);
      
      // Front fill light to eliminate dark areas
      const directionalLight3 = new THREE.DirectionalLight(0xffffff, 0.8);
      directionalLight3.position.set(0, 5, 10);
      scene.add(directionalLight3);
      
      // Add hemisphere light for natural classroom lighting
      const hemisphereLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6);
      hemisphereLight.position.set(0, 20, 0);
      scene.add(hemisphereLight);
      
      // Add classroom environment
      createClassroomEnvironment();
      
      // Handle resize
      window.addEventListener('resize', onWindowResize, false);
      
      // Start render loop
      animate();
    }
    
    function createClassroomEnvironment() {
      // Create classroom floor
      const floorGeometry = new THREE.PlaneGeometry(50, 50);
      const floorMaterial = new THREE.MeshLambertMaterial({ 
        color: 0x8B4513, // Brown wooden floor
        transparent: true,
        opacity: 0.8
      });
      const floor = new THREE.Mesh(floorGeometry, floorMaterial);
      floor.rotation.x = -Math.PI / 2;
      floor.position.y = -10;
      scene.add(floor);
      
      // Create classroom walls
      // Back wall
      const wallGeometry = new THREE.PlaneGeometry(50, 30);
      const wallMaterial = new THREE.MeshLambertMaterial({ 
        color: 0xF5F5DC, // Beige wall color
        transparent: true,
        opacity: 0.7
      });
      const backWall = new THREE.Mesh(wallGeometry, wallMaterial);
      backWall.position.set(0, 5, -25);
      scene.add(backWall);
      
      // Side walls
      const leftWall = new THREE.Mesh(wallGeometry, wallMaterial);
      leftWall.rotation.y = Math.PI / 2;
      leftWall.position.set(-25, 5, 0);
      scene.add(leftWall);
      
      const rightWall = new THREE.Mesh(wallGeometry, wallMaterial);
      rightWall.rotation.y = -Math.PI / 2;
      rightWall.position.set(25, 5, 0);
      scene.add(rightWall);
      
      // Create whiteboard on back wall
      const whiteboardGeometry = new THREE.PlaneGeometry(15, 8);
      const whiteboardMaterial = new THREE.MeshLambertMaterial({ 
        color: 0xFFFFFF // White
      });
      const whiteboard = new THREE.Mesh(whiteboardGeometry, whiteboardMaterial);
      whiteboard.position.set(0, 8, -24.9);
      scene.add(whiteboard);
      
      // Add whiteboard frame
      const frameGeometry = new THREE.PlaneGeometry(16, 9);
      const frameMaterial = new THREE.MeshLambertMaterial({ 
        color: 0x333333 // Dark frame
      });
      const frame = new THREE.Mesh(frameGeometry, frameMaterial);
      frame.position.set(0, 8, -24.95);
      scene.add(frame);
      
      // Create desks
      for (let i = 0; i < 3; i++) {
        for (let j = 0; j < 2; j++) {
          const deskGeometry = new THREE.BoxGeometry(3, 1.5, 2);
          const deskMaterial = new THREE.MeshLambertMaterial({ 
            color: 0xDEB887 // Light wood color
          });
          const desk = new THREE.Mesh(deskGeometry, deskMaterial);
          desk.position.set((i - 1) * 8, -8, (j - 0.5) * 6 + 5);
          scene.add(desk);
          
          // Add chairs
          const chairGeometry = new THREE.BoxGeometry(1.5, 3, 1.5);
          const chairMaterial = new THREE.MeshLambertMaterial({ 
            color: 0x4169E1 // Blue chairs
          });
          const chair = new THREE.Mesh(chairGeometry, chairMaterial);
          chair.position.set((i - 1) * 8, -6, (j - 0.5) * 6 + 8);
          scene.add(chair);
        }
      }
      
      // Add ceiling lights (visual only)
      for (let i = 0; i < 3; i++) {
        const lightGeometry = new THREE.BoxGeometry(4, 0.2, 1);
        const lightMaterial = new THREE.MeshBasicMaterial({ 
          color: 0xFFFFFF,
          emissive: 0x404040
        });
        const ceilingLight = new THREE.Mesh(lightGeometry, lightMaterial);
        ceilingLight.position.set((i - 1) * 10, 18, 0);
        scene.add(ceilingLight);
      }
    }
    
    function loadModel(filename) {
      const loadingIndicator = document.getElementById('loadingIndicator');
      loadingIndicator.style.display = 'block';
      loadingIndicator.textContent = 'Loading 3D model...';
      
      // Remove current model
      if (currentModel) {
        scene.remove(currentModel);
      }
      
      const loader = new THREE.STLLoader();
      loader.load(
        `../assets/${filename}`,
        function(geometry) {
          // Simple white material
          const material = new THREE.MeshPhongMaterial({ color: 0xffffff });
          currentModel = new THREE.Mesh(geometry, material);
          
          // Center and scale the model
          geometry.computeBoundingBox();
          const box = geometry.boundingBox;
          const center = box.getCenter(new THREE.Vector3());
          geometry.translate(-center.x, -center.y, -center.z);
          
          const size = box.getSize(new THREE.Vector3());
          const maxDim = Math.max(size.x, size.y, size.z);
          const scale = 2 / maxDim;
          currentModel.scale.setScalar(scale);
          
          scene.add(currentModel);
          loadingIndicator.style.display = 'none';
          console.log(`Loaded model: ${filename}`);
        },
        function(progress) {
          if (progress.total > 0) {
            const percent = Math.round(progress.loaded / progress.total * 100);
            loadingIndicator.textContent = `Loading... ${percent}%`;
          }
        },
        function(error) {
          console.error('Error loading STL:', error);
          loadingIndicator.textContent = 'Error loading model. Please try again.';
          setTimeout(() => {
            loadingIndicator.style.display = 'none';
          }, 3000);
        }
      );
    }
    
    function setupEventListeners() {
      // Model selection buttons
      document.querySelectorAll('.model-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.model-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          loadModel(this.dataset.model);
        });
      });
      
      // Simplified control buttons (removed arrow controls)
      document.getElementById('btnStlZoomIn').addEventListener('click', () => zoomCamera(-0.5));
      document.getElementById('btnStlZoomOut').addEventListener('click', () => zoomCamera(0.5));
      document.getElementById('btnStlReset').addEventListener('click', resetView);
      document.getElementById('btnStlAuto').addEventListener('click', toggleAutoRotate);
      document.getElementById('btnHome').addEventListener('click', goHome);
      
      // Prevent default touch behaviors on the entire app
      document.addEventListener('touchstart', function(e) {
        if (e.touches.length > 1) {
          e.preventDefault();
        }
      }, { passive: false });
      
      document.addEventListener('touchmove', function(e) {
        if (e.touches.length > 1) {
          e.preventDefault();
        }
      }, { passive: false });
    }
    
    function zoomCamera(delta) {
      camera.position.multiplyScalar(1 + delta);
      camera.updateProjectionMatrix();
    }
    
    function resetView() {
      camera.position.set(0, 0, 2.5); // Doubled zoom (halved distance)
      controls.reset();
      if (currentModel) {
        currentModel.rotation.set(0, 0, 0);
      }
    }
    
    function toggleAutoRotate() {
      autoRotate = !autoRotate;
      const btn = document.getElementById('btnStlAuto');
      btn.textContent = autoRotate ? 'Stop Auto' : 'Auto';
      btn.classList.toggle('active', autoRotate);
    }
    
    function onWindowResize() {
      const canvas = document.getElementById('stlCanvas');
      camera.aspect = canvas.offsetWidth / canvas.offsetHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(canvas.offsetWidth, canvas.offsetHeight);
    }
    
    function animate() {
      requestAnimationFrame(animate);
      
      // Auto rotate model
      if (autoRotate && currentModel) {
        currentModel.rotation.y += 0.01;
      }
      
      controls.update();
      renderer.render(scene, camera);
    }
    
    function goHome() {
      window.location.href = '../index.html';
    }
    
    // Start loading dependencies when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadDependencies);
    } else {
      loadDependencies();
    }
  })();
</script>
</body>
</html>
