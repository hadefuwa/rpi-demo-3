<section id="screen-printer" class="screen" aria-label="Printer Demo">
    <header class="printer-header">
      <img src="../assets/Matrix.png" alt="Matrix TSL" class="logo matrix-logo" />
      <h1 class="title">Printer Demo</h1>
      <div class="header-right">
        <div class="net-dot" title="Network status"></div>
        <button id="btnHome" class="home-button" aria-label="Home">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
          </svg>
        </button>
      </div>
    </header>
  
    <main class="grid">
      <!-- Card 1: Progress + ETA -->
      <section class="card progress-card" aria-label="Job status">
                 <div class="mesh-container">
           <div class="mesh" id="rotating-mesh">
             <!-- Main body faces -->
             <div class="mesh-face front"></div>
             <div class="mesh-face back"></div>
             <div class="mesh-face left"></div>
             <div class="mesh-face right"></div>
             <div class="mesh-face top"></div>
             <div class="mesh-face bottom"></div>
             <!-- Additional geometric faces for complexity -->
             <div class="mesh-face front-top"></div>
             <div class="mesh-face front-bottom"></div>
             <div class="mesh-face left-top"></div>
             <div class="mesh-face left-bottom"></div>
             <div class="mesh-face right-top"></div>
             <div class="mesh-face right-bottom"></div>
             <div class="mesh-face back-top"></div>
             <div class="mesh-face back-bottom"></div>
             <!-- Corner pieces -->
             <div class="mesh-face corner-front-left-top"></div>
             <div class="mesh-face corner-front-right-top"></div>
             <div class="mesh-face corner-front-left-bottom"></div>
             <div class="mesh-face corner-front-right-bottom"></div>
             <div class="mesh-face corner-back-left-top"></div>
             <div class="mesh-face corner-back-right-top"></div>
             <div class="mesh-face corner-back-left-bottom"></div>
             <div class="mesh-face corner-back-right-bottom"></div>
           </div>
         </div>
        <div class="progress-text">
          <div class="job-name" id="job-name">No job</div>
          <div class="progress-slider">
            <div class="progress-bar">
              <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="progress-percent" id="progress-percent">0%</div>
          </div>
          <div class="eta" id="eta">ETA —</div>
          <div class="layer" id="layer">Layer —</div>
        </div>
      </section>
  
      <!-- Card 2: Temps -->
      <section class="card temps-card" aria-label="Temperatures">
        <div class="temp">
          <div class="label">Nozzle</div>
          <div class="bar"><div class="fill" id="nozzle-fill"></div></div>
          <div class="vals"><span id="nozzle-actual">0</span>/<span id="nozzle-target">0</span> °C</div>
        </div>
        <div class="temp">
          <div class="label">Bed</div>
          <div class="bar"><div class="fill" id="bed-fill"></div></div>
          <div class="vals"><span id="bed-actual">0</span>/<span id="bed-target">0</span> °C</div>
        </div>
        <div class="speed">
          <label for="speed" class="label">Speed</label>
          <input id="speed" type="range" min="50" max="150" value="100" step="5" />
          <span class="speed-val" id="speed-val">100%</span>
        </div>
      </section>
  
      <!-- Card 3: Camera -->
      <section class="card cam-card" aria-label="Camera">
        <div class="cam-wrap">
          <img id="cam" alt="Camera preview" />
          <div class="cam-status" id="cam-status">Camera offline</div>
        </div>
        <button class="btn btn-small" id="cam-fullscreen">Full screen</button>
      </section>
  
      <!-- Card 4: Materials + Controls -->
      <section class="card mat-card" aria-label="Materials and controls">
        <div class="ams" id="ams">
          <!-- 4 slots -->
          <div class="slot" data-slot="0"><span class="chip"></span><div class="meta"></div></div>
          <div class="slot" data-slot="1"><span class="chip"></span><div class="meta"></div></div>
          <div class="slot" data-slot="2"><span class="chip"></span><div class="meta"></div></div>
          <div class="slot" data-slot="3"><span class="chip"></span><div class="meta"></div></div>
        </div>
        <div class="controls">
          <button class="btn" data-action="pause">Pause</button>
          <button class="btn" data-action="resume">Resume</button>
          <button class="btn btn-danger" data-action="cancel">Cancel</button>
        </div>
      </section>
    </main>
  
    <footer class="footer">
      <div class="state-pill" id="state-pill">Idle</div>
      <div class="fps" id="fps">FPS —</div>
    </footer>
  
    <!-- Debug controls removed -->
  </section>
  
  <style>
    /* All styles strictly scoped to #screen-printer */
    #screen-printer { width: 100%; height: 100vh; background:#0b0c10; color:#eef2f7; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; overflow:hidden; }
    #screen-printer * { box-sizing: border-box; touch-action: manipulation; user-select: none; }
    #screen-printer .printer-header { display:flex; align-items:center; justify-content:space-between; padding:8px 10px; background:#101218; border-bottom:1px solid #1c2030; }
    #screen-printer .title { font-size:16px; margin:0; }
    #screen-printer .header-right { display: flex; align-items: center; gap: 10px; }
    #screen-printer .net-dot { width:10px; height:10px; border-radius:50%; background:#888; }
    #screen-printer .matrix-logo { height: 32px; width: auto; opacity: 0.9; }
    #screen-printer .home-button { width: 36px; height: 36px; border-radius: 8px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); color: #e4e6f1; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; padding: 0; }
    #screen-printer .home-button:hover { background: rgba(255, 255, 255, 0.1); }
    #screen-printer .home-button:active { transform: scale(0.95); }
    #screen-printer .net-dot.online { background:#28c76f; }
    #screen-printer .grid { 
      display:grid; 
      grid-template-columns: 1fr 1fr; 
      grid-template-rows: 1fr 1fr; 
      gap:12px; 
      padding:12px; 
      height: calc(100vh - 86px); /* Adjust height to fill available space (100vh - header - footer) */
    }
    #screen-printer .card { 
      background:#121420; 
      border:1px solid #1c2030; 
      border-radius:12px; 
      padding:16px; 
      position:relative; 
      overflow:hidden;
      display: flex;
      flex-direction: column;
    }
         /* Progress */
     #screen-printer .progress-card { display:flex; align-items:center; justify-content:space-between; gap:20px; padding: 8px; }
    
    /* 3D Mesh */
    #screen-printer .mesh-container { 
      width: min(120px, 25%); 
      height: min(120px, 25%);
      perspective: 400px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
         #screen-printer .mesh { 
       width: 60px; 
       height: 60px; 
       position: relative;
       transform-style: preserve-3d;
       animation: rotate 6s linear infinite;
     }
     #screen-printer .mesh-face { 
       position: absolute; 
       background: linear-gradient(45deg, #4f8cff, #2b60ff);
       border: 1px solid #1c2030;
       opacity: 0.7;
     }
     
     /* Main body faces - larger core */
     #screen-printer .mesh-face.front { 
       width: 50px; height: 50px; 
       transform: translateZ(25px); 
     }
     #screen-printer .mesh-face.back { 
       width: 50px; height: 50px; 
       transform: translateZ(-25px) rotateY(180deg); 
     }
     #screen-printer .mesh-face.left { 
       width: 50px; height: 50px; 
       transform: translateX(-25px) rotateY(-90deg); 
     }
     #screen-printer .mesh-face.right { 
       width: 50px; height: 50px; 
       transform: translateX(25px) rotateY(90deg); 
     }
     #screen-printer .mesh-face.top { 
       width: 50px; height: 50px; 
       transform: translateY(-25px) rotateX(90deg); 
     }
     #screen-printer .mesh-face.bottom { 
       width: 50px; height: 50px; 
       transform: translateY(25px) rotateX(-90deg); 
     }
     
     /* Additional geometric faces - smaller protruding pieces */
     #screen-printer .mesh-face.front-top { 
       width: 20px; height: 20px; 
       transform: translateZ(35px) translateY(-15px); 
       background: linear-gradient(45deg, #5a9eff, #3b70ff);
     }
     #screen-printer .mesh-face.front-bottom { 
       width: 20px; height: 20px; 
       transform: translateZ(35px) translateY(15px); 
       background: linear-gradient(45deg, #5a9eff, #3b70ff);
     }
     #screen-printer .mesh-face.left-top { 
       width: 20px; height: 20px; 
       transform: translateX(-35px) translateY(-15px) rotateY(-90deg); 
       background: linear-gradient(45deg, #5a9eff, #3b70ff);
     }
     #screen-printer .mesh-face.left-bottom { 
       width: 20px; height: 20px; 
       transform: translateX(-35px) translateY(15px) rotateY(-90deg); 
       background: linear-gradient(45deg, #5a9eff, #3b70ff);
     }
     #screen-printer .mesh-face.right-top { 
       width: 20px; height: 20px; 
       transform: translateX(35px) translateY(-15px) rotateY(90deg); 
       background: linear-gradient(45deg, #5a9eff, #3b70ff);
     }
     #screen-printer .mesh-face.right-bottom { 
       width: 20px; height: 20px; 
       transform: translateX(35px) translateY(15px) rotateY(90deg); 
       background: linear-gradient(45deg, #5a9eff, #3b70ff);
     }
     #screen-printer .mesh-face.back-top { 
       width: 20px; height: 20px; 
       transform: translateZ(-35px) translateY(-15px) rotateY(180deg); 
       background: linear-gradient(45deg, #5a9eff, #3b70ff);
     }
     #screen-printer .mesh-face.back-bottom { 
       width: 20px; height: 20px; 
       transform: translateZ(-35px) translateY(15px) rotateY(180deg); 
       background: linear-gradient(45deg, #5a9eff, #3b70ff);
     }
     
     /* Corner pieces - small triangular-like shapes */
     #screen-printer .mesh-face.corner-front-left-top { 
       width: 15px; height: 15px; 
       transform: translateZ(40px) translateX(-12px) translateY(-12px) rotateX(45deg) rotateY(-45deg); 
       background: linear-gradient(45deg, #6aaeff, #4b80ff);
     }
     #screen-printer .mesh-face.corner-front-right-top { 
       width: 15px; height: 15px; 
       transform: translateZ(40px) translateX(12px) translateY(-12px) rotateX(45deg) rotateY(45deg); 
       background: linear-gradient(45deg, #6aaeff, #4b80ff);
     }
     #screen-printer .mesh-face.corner-front-left-bottom { 
       width: 15px; height: 15px; 
       transform: translateZ(40px) translateX(-12px) translateY(12px) rotateX(-45deg) rotateY(-45deg); 
       background: linear-gradient(45deg, #6aaeff, #4b80ff);
     }
     #screen-printer .mesh-face.corner-front-right-bottom { 
       width: 15px; height: 15px; 
       transform: translateZ(40px) translateX(12px) translateY(12px) rotateX(-45deg) rotateY(45deg); 
       background: linear-gradient(45deg, #6aaeff, #4b80ff);
     }
     #screen-printer .mesh-face.corner-back-left-top { 
       width: 15px; height: 15px; 
       transform: translateZ(-40px) translateX(-12px) translateY(-12px) rotateX(45deg) rotateY(135deg); 
       background: linear-gradient(45deg, #6aaeff, #4b80ff);
     }
     #screen-printer .mesh-face.corner-back-right-top { 
       width: 15px; height: 15px; 
       transform: translateZ(-40px) translateX(12px) translateY(-12px) rotateX(45deg) rotateY(-135deg); 
       background: linear-gradient(45deg, #6aaeff, #4b80ff);
     }
     #screen-printer .mesh-face.corner-back-left-bottom { 
       width: 15px; height: 15px; 
       transform: translateZ(-40px) translateX(-12px) translateY(12px) rotateX(-45deg) rotateY(135deg); 
       background: linear-gradient(45deg, #6aaeff, #4b80ff);
     }
     #screen-printer .mesh-face.corner-back-right-bottom { 
       width: 15px; height: 15px; 
       transform: translateZ(-40px) translateX(12px) translateY(12px) rotateX(-45deg) rotateY(-135deg); 
       background: linear-gradient(45deg, #6aaeff, #4b80ff);
     }
    
    @keyframes rotate {
      from { transform: rotateX(0deg) rotateY(0deg); }
      to { transform: rotateX(360deg) rotateY(360deg); }
    }
    
         /* Progress Slider */
     #screen-printer .progress-text { display:flex; flex-direction:column; gap:8px; min-width:160px; flex: 1; }
    #screen-printer .progress-slider { 
      display: flex; 
      align-items: center; 
      gap: 12px; 
      margin: 8px 0;
    }
    #screen-printer .progress-bar { 
      flex: 1; 
      height: 8px; 
      background: #23283d; 
      border-radius: 4px; 
      overflow: hidden; 
    }
    #screen-printer .progress-fill { 
      height: 100%; 
      width: 0%; 
      background: linear-gradient(90deg, #4f8cff, #2b60ff);
      border-radius: 4px;
      transition: width 150ms linear;
    }
    #screen-printer .progress-percent { 
      font-size: clamp(12px, 2vmin, 16px); 
      color: #4f8cff; 
      font-weight: bold;
      min-width: 32px;
      text-align: right;
    }
         #screen-printer .job-name { 
       font-size: clamp(13px, 2.2vmin, 16px); 
       white-space:nowrap; 
       overflow:hidden; 
       text-overflow:ellipsis; 
       margin-bottom: 4px;
     }
    #screen-printer .eta, #screen-printer .layer { 
      font-size: clamp(12px, 2vmin, 16px); 
      color:#aab2c5; 
    }
    /* Temps */
    #screen-printer .temps-card { 
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 0;
    }
    #screen-printer .temps-card .temp { 
      margin-bottom: clamp(8px, 2vh, 16px); 
    }
    #screen-printer .temps-card .label { 
      font-size: clamp(12px, 2vmin, 16px); 
      color:#aab2c5; 
      margin-bottom:4px; 
    }
    #screen-printer .temps-card .bar { 
      width:100%; 
      height: clamp(12px, 2vh, 20px); 
      background:#22263a; 
      border-radius:8px; 
      overflow:hidden; 
    }
    #screen-printer .temps-card .fill { 
      height:100%; 
      width:0%; 
      background: linear-gradient(90deg, #4a90e2, #ff6b6b);
      transition: width 150ms linear; 
    }
    #screen-printer .temps-card .vals { 
      font-size: clamp(12px, 2vmin, 16px); 
      color:#cfd6e6; 
      margin-top:4px; 
    }
    #screen-printer .speed { 
      display:flex; 
      align-items:center; 
      gap:10px; 
      margin-top: auto;
      padding-top: clamp(8px, 2vh, 16px);
    }
    #screen-printer .speed input[type="range"] { 
      flex:1; 
      height: clamp(12px, 1.5vh, 20px);
      min-width: 0;
    }
    #screen-printer .speed .speed-val { 
      width:48px; 
      text-align:right; 
      font-size: clamp(12px, 2vmin, 16px); 
      color:#cfd6e6; 
    }
    /* Camera */
    #screen-printer .cam-wrap { 
      position:relative; 
      width:100%; 
      height:100%; 
      background:#0f111a; 
      border-radius:8px; 
      overflow:hidden; 
      border:1px solid #1c2030; 
      display:flex; 
      align-items:center; 
      justify-content:center;
    }
    
    /* Fullscreen exit button - only visible when in fullscreen */
    #screen-printer .cam-wrap.fullscreen::after {
      content: "✕";
      position: absolute;
      top: 10px;
      right: 10px;
      width: 40px;
      height: 40px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      z-index: 1000;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }
    #screen-printer .cam-wrap img { 
      width:100%; 
      height:100%; 
      object-fit:contain; /* Changed from cover to contain to preserve aspect ratio */
      image-rendering: auto; /* Ensure smooth rendering */
    }
    #screen-printer .cam-status { position:absolute; bottom:4px; right:4px; font-size:10px; background:#1d2233; padding:2px 6px; border-radius:6px; color:#aab2c5; }
    /* Materials + controls */
    #screen-printer .ams { 
      display:grid; 
      grid-template-columns: repeat(4, 1fr); 
      gap:10px; 
      margin-bottom: clamp(12px, 3vh, 24px); 
      flex: 1;
    }
    #screen-printer .slot { 
      background:#0f111a; 
      border:1px solid #1c2030; 
      border-radius:8px; 
      padding:8px; 
      display:flex; 
      gap:8px; 
      align-items:center; 
    }
    #screen-printer .slot .chip { 
      width: clamp(16px, 2.5vmin, 24px); 
      height: clamp(16px, 2.5vmin, 24px); 
      border-radius:4px; 
      border:1px solid #0008; 
      display:inline-block; 
    }
    #screen-printer .slot .meta { 
      font-size: clamp(11px, 1.8vmin, 14px); 
      color:#cfd6e6; 
      line-height:1.2; 
    }
    #screen-printer .controls { 
      display:flex; 
      gap:10px; 
      justify-content: space-between;
      margin-top: auto;
    }
    /* Footer */
    #screen-printer .footer { height:36px; padding:6px 8px; display:flex; align-items:center; justify-content:space-between; border-top:1px solid #1c2030; background:#101218; }
    #screen-printer .state-pill { font-size:12px; padding:4px 8px; border-radius:999px; background:#1d2233; color:#aab2c5; }
    #screen-printer .fps { font-size:12px; color:#aab2c5; }
    /* Buttons */
    #screen-printer .btn { 
      background:#2b60ff; 
      color:#fff; 
      border:none; 
      padding: clamp(8px, 1.5vh, 12px) clamp(10px, 2vw, 16px); 
      border-radius:8px; 
      font-size: clamp(13px, 2vmin, 16px);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    #screen-printer .btn:active { 
      transform: translateY(1px); 
    }
    #screen-printer .btn:hover {
      filter: brightness(1.1);
    }
    #screen-printer .btn-small { 
      padding: clamp(6px, 1vh, 10px) clamp(8px, 1.5vw, 14px); 
      font-size: clamp(12px, 1.8vmin, 14px); 
      background:#38435f; 
    }
    #screen-printer .btn-danger { 
      background:#e24c4c; 
    }
    #screen-printer .btn-back { background:#38435f; }
  </style>
  
  <script>
  (function() {
    'use strict';
    const root = document.getElementById('screen-printer');
  
    // UI refs (scoped)
    const progressFill = root.querySelector('#progress-fill');
    const progressPercent = root.querySelector('#progress-percent');
    const nameEl = root.querySelector('#job-name');
    const etaEl = root.querySelector('#eta');
    const layerEl = root.querySelector('#layer');
    const nozFill = root.querySelector('#nozzle-fill');
    const bedFill = root.querySelector('#bed-fill');
    const nozAct = root.querySelector('#nozzle-actual');
    const bedAct = root.querySelector('#bed-actual');
    const nozTar = root.querySelector('#nozzle-target');
    const bedTar = root.querySelector('#bed-target');
    const speedRange = root.querySelector('#speed');
    const speedVal = root.querySelector('#speed-val');
    const statePill = root.querySelector('#state-pill');
    const fpsEl = root.querySelector('#fps');
    const netDot = root.querySelector('.net-dot');
    const cam = root.querySelector('#cam');
    const camStatus = root.querySelector('#cam-status');
  
    // AMS slots
    const slotEls = Array.from(root.querySelectorAll('.slot'));
  
    // Constants
    // No longer needed - using simple percentage for progress slider
  
    // Local state
    let uiState = null;
    let rafId = 0;
    let lastFrameTs = 0;
    let frames = 0;
    let fpsTimer = 0;
    let online = true;
    let worker = null;
    let listeners = [];
  
    // Inline Web Worker via Blob, to keep file self-contained
    function makeWorker() {
      const code = `
        let state = {
          phase: "idle",
          job: null,
          temps: { nozzle: 25, bed: 25, tNozzle: 0, tBed: 0 },
          speed: { multiplier: 100 },
          materials: { slots: [
            { id:"A1", type:"PLA", color:"#f94144", grams:230, active:true },
            { id:"A2", type:"PLA", color:"#577590", grams:180, active:false },
            { id:"A3", type:"PETG", color:"#90be6d", grams:150, active:false },
            { id:"A4", type:"ABS", color:"#f9c74f", grams:90, active:false }
          ]},
          camera: { url:"", online:false },
          ts: Date.now()
        };
        let tickMs = 200;
        let layerTimeMs = 4000; // base per layer at 100%
        let layersTotal = 120;
        let heatingPhase = 0;
        let timer = 0;
  
        function startJob(name) {
          state.phase = "heating";
          state.temps.tNozzle = 210;
          state.temps.tBed = 60;
          state.job = { name, progress:0, layer:0, layers:layersTotal, etaSec: layersTotal * layerTimeMs / 1000 };
          heatingPhase = 0;
          post();
        }
  
        function pause() {
          if (state.phase === "printing") state.phase = "paused";
          post();
        }
  
        function resume() {
          if (state.phase === "paused") state.phase = "printing";
          post();
        }
  
        function cancel() {
          state.phase = "cooling";
          post();
        }
  
        function setSpeed(mult) {
          state.speed.multiplier = mult;
          post();
        }
  
        function filamentOut() {
          state.phase = "paused";
          postMessage({ banner: "Filament runout detected. Replace and resume." });
          post();
        }
  
        function tempFault() {
          state.phase = "error";
          postMessage({ banner: "Temperature fault. Check heater/thermistor." });
          post();
        }
  
        function heatToward(target, actual) {
          const d = target - actual;
          return actual + Math.sign(d) * Math.min(Math.abs(d), 4);
        }
  
        function coolToward(target, actual) {
          const d = target - actual;
          return actual + Math.sign(d) * Math.min(Math.abs(d), 2);
        }
  
        function post() { state.ts = Date.now(); postMessage({ type: "state", state }); }
  
        function loop() {
          timer = setTimeout(loop, tickMs);
          // temps
          if (state.phase === "heating" || state.phase === "printing") {
            state.temps.nozzle = heatToward(state.temps.tNozzle, state.temps.nozzle);
            state.temps.bed = heatToward(state.temps.tBed, state.temps.bed);
          } else {
            state.temps.nozzle = coolToward(25, state.temps.nozzle);
            state.temps.bed = coolToward(25, state.temps.bed);
          }
  
          // phases
          if (state.phase === "heating") {
            heatingPhase += tickMs;
            const ready = Math.abs(state.temps.nozzle - state.temps.tNozzle) < 2 && Math.abs(state.temps.bed - state.temps.tBed) < 2;
            if (ready || heatingPhase > 5000) state.phase = "homing";
          } else if (state.phase === "homing") {
            // brief homing then print
            heatingPhase += tickMs;
            if (heatingPhase > 7000) state.phase = "printing";
          } else if (state.phase === "printing") {
            const mult = state.speed.multiplier / 100;
            const effectiveLayerMs = layerTimeMs / mult;
            // advance progress
            if (!state._acc) state._acc = 0;
            state._acc += tickMs;
            while (state._acc >= effectiveLayerMs) {
              state._acc -= effectiveLayerMs;
              state.job.layer = Math.min(state.job.layer + 1, state.job.layers);
            }
            state.job.progress = Math.round((state.job.layer / state.job.layers) * 100);
            const remainingLayers = state.job.layers - state.job.layer;
            state.job.etaSec = Math.max(0, Math.round(remainingLayers * effectiveLayerMs / 1000));
            if (state.job.layer >= state.job.layers) state.phase = "cooling";
          } else if (state.phase === "cooling") {
            const coolDone = state.temps.nozzle <= 30 && state.temps.bed <= 30;
            if (coolDone) { state.phase = "complete"; }
          }
          post();
        }
  
        onmessage = (e) => {
          const { type, data } = e.data || {};
          if (type === "cmd") {
            if (data === "start") startJob("Gearbox_cover_v7.gcode");
            else if (data === "pause") pause();
            else if (data === "resume") resume();
            else if (data === "cancel") cancel();
            else if (data && data.speed) setSpeed(data.speed);
            else if (data === "filament-out") filamentOut();
            else if (data === "temp-fault") tempFault();
          } else if (type === "lifecycle") {
            if (data === "start") { loop(); }
            else if (data === "stop") { clearTimeout(timer); }
            else if (data === "terminate") { clearTimeout(timer); close(); }
          }
        };
        post(); // initial
      `;
      const blob = new Blob([code], { type: 'application/javascript' });
      return new Worker(URL.createObjectURL(blob));
    }
  
    // UI helpers
    function fmtETA(sec) {
      if (sec == null) return 'ETA —';
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `ETA ${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }
  
    function setProgress(pct) {
      const clamped = Math.max(0, Math.min(100, pct || 0));
      progressFill.style.width = `${clamped}%`;
      progressPercent.textContent = `${Math.round(clamped)}%`;
    }
  
    function applyTemps(noz, nozT, bed, bedT) {
      nozAct.textContent = Math.round(noz);
      bedAct.textContent = Math.round(bed);
      nozTar.textContent = Math.round(nozT);
      bedTar.textContent = Math.round(bedT);
      const nz = Math.min(100, Math.max(0, (nozT ? noz / nozT : 0) * 100));
      const bd = Math.min(100, Math.max(0, (bedT ? bed / bedT : 0) * 100));
      nozFill.style.width = `${nz}%`;
      bedFill.style.width = `${bd}%`;
      
      // Dynamic colors based on temperature
      // Nozzle: Blue (cold) to Red (hot)
      const nozzleColor = getTempColor(noz, 25, 250);
      nozFill.style.background = nozzleColor;
      
      // Bed: Blue (cold) to Red (hot)  
      const bedColor = getTempColor(bed, 25, 120);
      bedFill.style.background = bedColor;
    }
    
    function getTempColor(temp, minTemp, maxTemp) {
      // Clamp temperature between min and max
      const clamped = Math.max(minTemp, Math.min(maxTemp, temp));
      // Calculate percentage (0 = cold/blue, 1 = hot/red)
      const percent = (clamped - minTemp) / (maxTemp - minTemp);
      
      // Interpolate between blue and red
      const blue = Math.round(226 - (percent * 226)); // 226 to 0
      const red = Math.round(107 + (percent * 148));  // 107 to 255
      const green = Math.round(74 + (percent * 97));  // 74 to 171
      
      return `rgb(${red}, ${green}, ${blue})`;
    }
  
    function applyAMS(slots) {
      slots.slice(0,4).forEach((s, i) => {
        const el = slotEls[i];
        if (!el) return;
        el.querySelector('.chip').style.background = s.color;
        el.querySelector('.meta').textContent = `${s.type} • ${s.grams} g${s.active ? ' • Active' : ''}`;
        el.style.outline = s.active ? '2px solid #4f8cff' : 'none';
      });
    }
  
    function setStatePill(phase) {
      statePill.textContent = phase.charAt(0).toUpperCase() + phase.slice(1);
    }
  
    function setNetworkDot(isOnline) {
      online = isOnline;
      netDot.classList.toggle('online', online);
    }
  
    function setCamera(url, isOnline) {
      camStatus.textContent = isOnline ? 'Live' : 'Camera offline';
      if (isOnline && url) { 
        // Only set the source if it's not already set or if it's different
        if (cam.src !== url && !cam.src.includes(url)) {
          cam.src = url;
        }
        
        // Ensure proper GIF playback attributes
        cam.setAttribute('loading', 'eager');
        cam.setAttribute('decoding', 'sync');
      } else { 
        cam.removeAttribute('src'); 
      }
    }
  
    function handleBanner(msg) {
      if (!msg) return;
      // Very light inline banner
      const b = document.createElement('div');
      b.textContent = msg;
      b.style.position = 'absolute';
      b.style.left = '8px';
      b.style.right = '8px';
      b.style.top = '8px';
      b.style.padding = '8px';
      b.style.borderRadius = '8px';
      b.style.background = '#e8a317';
      b.style.color = '#111';
      b.style.fontSize = '12px';
      b.style.zIndex = '10';
      root.appendChild(b);
      setTimeout(() => b.remove(), 2500);
    }
  
    // Animation loop for tiny UI effects and FPS
    function frame(ts) {
      frames++;
      if (!lastFrameTs) lastFrameTs = ts;
      if (ts - lastFrameTs >= 1000) {
        fpsEl.textContent = `FPS ${frames}`;
        frames = 0;
        lastFrameTs = ts;
      }
      rafId = requestAnimationFrame(frame);
    }
  
    // Event wiring (scoped)
    function on(el, ev, fn) {
      el.addEventListener(ev, fn, { passive: true });
      listeners.push(() => el.removeEventListener(ev, fn));
    }
  
    // Lifecycle
    function activate() {
      // Start or resume worker and UI loop
      if (!worker) worker = makeWorker();
      worker.onmessage = (e) => {
        if (e.data && e.data.type === 'state') {
          uiState = e.data.state;
          // Map to UI
          const s = uiState;
          setStatePill(s.phase);
          setProgress(s.job ? s.job.progress : 0);
          nameEl.textContent = s.job ? s.job.name : 'No job';
          etaEl.textContent = s.job ? fmtETA(s.job.etaSec) : 'ETA —';
          layerEl.textContent = s.job ? `Layer ${s.job.layer}/${s.job.layers}` : 'Layer —';
          applyTemps(s.temps.nozzle, s.temps.tNozzle, s.temps.bed, s.temps.tBed);
          applyAMS(s.materials.slots);
          setNetworkDot(window.navigator.onLine);
          // Camera demo: if on LAN, set your stream URL here; otherwise offline
          setCamera('../assets/3d.gif', true);


        } else if (e.data && e.data.banner) {
          handleBanner(e.data.banner);
        }
      };
      worker.postMessage({ type: 'lifecycle', data: 'start' });
      rafId = requestAnimationFrame(frame);
    }
  
    function deactivate() {
      if (worker) worker.postMessage({ type: 'lifecycle', data: 'stop' });
      if (rafId) cancelAnimationFrame(rafId);
      rafId = 0;
    }
  
    function cleanup() {
      deactivate();
      if (worker) {
        worker.postMessage({ type: 'lifecycle', data: 'terminate' });
        worker.terminate();
        worker = null;
      }
      listeners.forEach(off => off());
      listeners = [];
    }
  
    // Home button
    const homeButton = root.querySelector('#btnHome');
    if (homeButton) {
      on(homeButton, 'click', function() {
        window.location.href = '../index.html';
      });
    }
    
    // Controls
    on(root, 'click', (e) => {
      const t = e.target;
      if (!(t instanceof Element)) return;
      const action = t.getAttribute('data-action');
      if (action === 'pause') worker && worker.postMessage({ type: 'cmd', data: 'pause' });
      else if (action === 'resume') worker && worker.postMessage({ type: 'cmd', data: 'resume' });
      else if (action === 'cancel') worker && worker.postMessage({ type: 'cmd', data: 'cancel' });
      // Demo injections
      const demo = t.getAttribute('data-demo');
      if (demo === 'filament-out') worker && worker.postMessage({ type: 'cmd', data: 'filament-out' });
      else if (demo === 'temp-fault') worker && worker.postMessage({ type: 'cmd', data: 'temp-fault' });
      else if (demo === 'new-job') worker && worker.postMessage({ type: 'cmd', data: 'start' });
    });
  
    // Touch parity for speed slider
    on(speedRange, 'input', () => {
      const v = Number(speedRange.value);
      speedVal.textContent = `${v}%`;
      worker && worker.postMessage({ type: 'cmd', data: { speed: v } });
    });
  
    // Camera fullscreen
    const camBtn = root.querySelector('#cam-fullscreen');
    const camWrap = root.querySelector('.cam-wrap');
    
    on(camBtn, 'click', () => {
      if (camWrap.requestFullscreen) {
        camWrap.requestFullscreen().then(() => {
          // Add fullscreen class for styling
          camWrap.classList.add('fullscreen');
        }).catch(err => {
          console.log('Fullscreen failed:', err);
        });
      }
    });
    
    // Handle fullscreen exit
    on(document, 'fullscreenchange', () => {
      if (!document.fullscreenElement) {
        // Remove fullscreen class when exiting
        camWrap.classList.remove('fullscreen');
      }
    });
    
    // Touch-friendly exit button (click on the X button)
    on(camWrap, 'click', (e) => {
      // Check if we're in fullscreen and clicked on the exit button area
      if (document.fullscreenElement && camWrap.classList.contains('fullscreen')) {
        const rect = camWrap.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        // Check if click is in the top-right corner (where the X button is)
        if (x > rect.width - 60 && y < 60) {
          if (document.exitFullscreen) {
            document.exitFullscreen();
          }
        }
      }
    });
  
    // Online/offline indicators
    on(window, 'online', () => setNetworkDot(true));
    on(window, 'offline', () => setNetworkDot(false));
  
    // Export required lifecycle in the expected shape
    window.appLifecycle = {
      activate,
      deactivate,
      cleanup
    };
  
    // Auto-init: start UI and immediately begin job simulation
    // If your framework calls activate/deactivate, remove this auto-activation.
    // For standalone testing:
    if (!window.showcaseFramework) {
      activate();
      // Start the job automatically after a short delay to allow UI to initialize
      setTimeout(() => {
        if (worker) {
          worker.postMessage({ type: 'cmd', data: 'start' });
        }
      }, 500);
    }
  })();
  </script>
