<section id="screen-printer" class="screen" aria-label="Printer Demo">
    <header class="printer-header">
      <img src="../assets/Matrix.png" alt="Matrix TSL" class="logo matrix-logo" />
      <h1 class="title">Printer Demo</h1>
      <div class="header-right">
        <div class="net-dot" title="Network status"></div>
        <button id="btnHome" class="home-button" aria-label="Home">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
          </svg>
        </button>
      </div>
    </header>
  
    <main class="grid">
             <!-- Card 1: Progress + ETA -->
       <section class="card progress-card" aria-label="Job status">
                     <div class="video-container">
             <video id="progress-video" autoplay muted loop playsinline>
               <source src="../assets/video.mp4" type="video/mp4">
             </video>
             <div class="video-overlay">
               <div class="gcode-name">gear_rev3.gcode</div>
             </div>
           </div>
        <div class="progress-text">
          <div class="job-name" id="job-name">No job</div>
          <div class="progress-slider">
            <div class="progress-bar">
              <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="progress-percent" id="progress-percent">0%</div>
          </div>
          <div class="eta" id="eta">ETA ‚Äî</div>
          <div class="layer" id="layer">Layer ‚Äî</div>
        </div>
      </section>
  
             <!-- Card 2: Temps -->
       <section class="card temps-card" aria-label="Temperatures">
         <div class="temp-container">
           <div class="temp nozzle-temp">
             <div class="temp-header">
               <div class="temp-icon">üî•</div>
               <div class="temp-label">Nozzle</div>
               <div class="temp-status" id="nozzle-status">Cold</div>
             </div>
             <div class="temp-visual">
               <div class="temp-circle">
                 <svg class="temp-progress" viewBox="0 0 120 120">
                   <circle class="temp-bg" cx="60" cy="60" r="50"></circle>
                   <circle class="temp-fill" id="nozzle-circle" cx="60" cy="60" r="50"></circle>
                 </svg>
                 <div class="temp-center">
                   <div class="temp-actual" id="nozzle-actual">0</div>
                   <div class="temp-unit">¬∞C</div>
                 </div>
               </div>
               <div class="temp-target">Target: <span id="nozzle-target">0</span>¬∞C</div>
             </div>
           </div>
           
           <div class="temp bed-temp">
             <div class="temp-header">
               <div class="temp-icon">üõèÔ∏è</div>
               <div class="temp-label">Bed</div>
               <div class="temp-status" id="bed-status">Cold</div>
             </div>
             <div class="temp-visual">
               <div class="temp-circle">
                 <svg class="temp-progress" viewBox="0 0 120 120">
                   <circle class="temp-bg" cx="60" cy="60" r="50"></circle>
                   <circle class="temp-fill" id="bed-circle" cx="60" cy="60" r="50"></circle>
                 </svg>
                 <div class="temp-center">
                   <div class="temp-actual" id="bed-actual">0</div>
                   <div class="temp-unit">¬∞C</div>
                 </div>
               </div>
               <div class="temp-target">Target: <span id="bed-target">0</span>¬∞C</div>
             </div>
           </div>
         </div>
         
         <div class="speed-container">
           <div class="speed-header">
             <div class="speed-icon">‚ö°</div>
             <div class="speed-label">Speed</div>
             <div class="speed-display" id="speed-display">100%</div>
           </div>
           <div class="speed-control">
             <div class="speed-slider-container">
               <input id="speed" type="range" min="50" max="150" value="100" step="5" />
               <div class="speed-track">
                 <div class="speed-fill" id="speed-fill"></div>
                 <div class="speed-knob" id="speed-knob"></div>
               </div>
             </div>
             <div class="speed-markers">
               <span class="marker">50%</span>
               <span class="marker">100%</span>
               <span class="marker">150%</span>
             </div>
           </div>
         </div>
       </section>
  
      <!-- Card 3: Camera -->
      <section class="card cam-card" aria-label="Camera">
        <div class="cam-wrap">
          <img id="cam" alt="Camera preview" />
          <div class="cam-status" id="cam-status">Camera offline</div>
        </div>
        <button class="btn btn-small" id="cam-fullscreen">Full screen</button>
      </section>
  
      <!-- Card 4: Materials + Controls -->
      <section class="card mat-card" aria-label="Materials and controls">
        <div class="ams" id="ams">
          <!-- 4 slots -->
          <div class="slot" data-slot="0"><span class="chip"></span><div class="meta"></div></div>
          <div class="slot" data-slot="1"><span class="chip"></span><div class="meta"></div></div>
          <div class="slot" data-slot="2"><span class="chip"></span><div class="meta"></div></div>
          <div class="slot" data-slot="3"><span class="chip"></span><div class="meta"></div></div>
        </div>
        <div class="controls">
          <button class="btn" data-action="pause">Pause</button>
          <button class="btn" data-action="resume">Resume</button>
          <button class="btn btn-danger" data-action="cancel">Cancel</button>
        </div>
      </section>
    </main>
  
    <footer class="footer">
      <div class="state-pill" id="state-pill">Idle</div>
      <div class="fps" id="fps">FPS ‚Äî</div>
    </footer>
  
    <!-- Debug controls removed -->
  </section>
  
  <style>
    /* Global reset to prevent scrollbars and white borders */
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      height: 100vh;
      width: 100vw;
    }
    
    /* All styles strictly scoped to #screen-printer */
    #screen-printer { 
      width: 100%; 
      height: 100vh; 
      background:#0b0c10; 
      color:#eef2f7; 
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; 
      overflow:hidden; 
      margin: 0;
      padding: 0;
    }
    #screen-printer * { box-sizing: border-box; touch-action: manipulation; user-select: none; }
    #screen-printer .printer-header { display:flex; align-items:center; justify-content:space-between; padding:8px 10px; background:#101218; border-bottom:1px solid #1c2030; }
    #screen-printer .title { font-size:16px; margin:0; }
    #screen-printer .header-right { display: flex; align-items: center; gap: 10px; }
    #screen-printer .net-dot { width:10px; height:10px; border-radius:50%; background:#888; }
    #screen-printer .matrix-logo { height: 32px; width: auto; opacity: 0.9; }
    #screen-printer .home-button { width: 36px; height: 36px; border-radius: 8px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); color: #e4e6f1; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; padding: 0; }
    #screen-printer .home-button:hover { background: rgba(255, 255, 255, 0.1); }
    #screen-printer .home-button:active { transform: scale(0.95); }
    #screen-printer .net-dot.online { background:#28c76f; }
    #screen-printer .grid { 
      display:grid; 
      grid-template-columns: 1fr 1fr; 
      grid-template-rows: 1fr 1fr; 
      gap:12px; 
      padding:12px; 
      height: calc(100vh - 86px); /* Adjust height to fill available space (100vh - header - footer) */
      min-height: 0; /* Prevent grid from overflowing */
      overflow: hidden; /* Ensure no scrollbars */
      max-height: calc(100vh - 86px); /* Ensure grid doesn't exceed viewport */
    }
    #screen-printer .card { 
      background:#121420; 
      border:1px solid #1c2030; 
      border-radius:12px; 
      padding:16px; 
      position:relative; 
      overflow:hidden;
      display: flex;
      flex-direction: column;
      min-height: 0; /* Prevent flex items from overflowing */
    }
                   /* Progress */
      #screen-printer .progress-card { 
        display:flex; 
        flex-direction: column;
        gap:16px; 
        padding: 16px; 
        height: 100%;
      }
    
                   /* Video Container */
      #screen-printer .video-container { 
        width: 70%; 
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        overflow: hidden;
        background: #0f111a;
        min-height: 200px;
        margin: 0 auto;
        flex-shrink: 0; /* Prevent shrinking */
      }
     
           #screen-printer .video-container video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 8px;
      }
      
      #screen-printer .video-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: flex-start;
        justify-content: flex-start;
        padding: 12px;
        pointer-events: none;
      }
      
      #screen-printer .gcode-name {
        background: rgba(0, 0, 0, 0.7);
        color: #22c55e;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        font-family: 'Courier New', monospace;
        border: 1px solid rgba(34, 197, 94, 0.3);
        backdrop-filter: blur(4px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }
    
                   /* Progress Slider */
      #screen-printer .progress-text { 
        display:flex; 
        flex-direction:column; 
        gap:12px; 
        width: 100%;
      }
    #screen-printer .progress-slider { 
      display: flex; 
      align-items: center; 
      gap: 12px; 
      margin: 8px 0;
    }
    #screen-printer .progress-bar { 
      flex: 1; 
      height: 8px; 
      background: #23283d; 
      border-radius: 4px; 
      overflow: hidden; 
    }
         #screen-printer .progress-fill { 
       height: 100%; 
       width: 0%; 
       background: linear-gradient(90deg, #4ade80, #22c55e);
       border-radius: 4px;
       transition: width 150ms linear;
     }
         #screen-printer .progress-percent { 
       font-size: clamp(12px, 2vmin, 16px); 
       color: #4ade80; 
       font-weight: bold;
       min-width: 32px;
       text-align: right;
     }
         #screen-printer .job-name { 
       font-size: clamp(13px, 2.2vmin, 16px); 
       white-space:nowrap; 
       overflow:hidden; 
       text-overflow:ellipsis; 
       margin-bottom: 4px;
     }
    #screen-printer .eta, #screen-printer .layer { 
      font-size: clamp(12px, 2vmin, 16px); 
      color:#aab2c5; 
    }
         /* Enhanced Temps */
     #screen-printer .temps-card { 
       display: flex;
       flex-direction: column;
       gap: 20px;
       min-height: 0;
     }
     
     #screen-printer .temp-container {
       display: flex;
       gap: 16px;
       flex: 1;
       min-height: 0; /* Prevent overflow */
       overflow: hidden; /* Ensure content fits */
     }
     
     #screen-printer .temp {
       flex: 1;
       background: rgba(255,255,255,0.02);
       border-radius: 12px;
       padding: 16px;
       border: 1px solid rgba(255,255,255,0.05);
       transition: all 0.3s ease;
       position: relative;
       overflow: hidden;
     }
     
     #screen-printer .temp::before {
       content: '';
       position: absolute;
       top: 0;
       left: 0;
       right: 0;
       height: 2px;
       background: linear-gradient(90deg, #22c55e, #4ade80);
       transform: scaleX(0);
       transition: transform 0.3s ease;
     }
     
     #screen-printer .temp.heating::before {
       transform: scaleX(1);
     }
     
     #screen-printer .temp-header {
       display: flex;
       align-items: center;
       gap: 8px;
       margin-bottom: 12px;
     }
     
     #screen-printer .temp-icon {
       font-size: 18px;
       animation: pulse 2s infinite;
     }
     
     #screen-printer .temp.heating .temp-icon {
       animation: heat-pulse 1s infinite;
     }
     
     #screen-printer .temp-label {
       font-size: 14px;
       font-weight: 600;
       color: #e4e6f1;
       flex: 1;
     }
     
     #screen-printer .temp-status {
       font-size: 11px;
       padding: 2px 8px;
       border-radius: 12px;
       background: rgba(255,255,255,0.1);
       color: #aab2c5;
       transition: all 0.3s ease;
     }
     
     #screen-printer .temp.heating .temp-status {
       background: #22c55e;
       color: white;
       animation: status-glow 2s infinite;
     }
     
     #screen-printer .temp-visual {
       display: flex;
       flex-direction: column;
       align-items: center;
       gap: 8px;
     }
     
     #screen-printer .temp-circle {
       position: relative;
       width: 80px;
       height: 80px;
     }
     
     #screen-printer .temp-progress {
       width: 100%;
       height: 100%;
       transform: rotate(-90deg);
     }
     
     #screen-printer .temp-bg {
       fill: none;
       stroke: rgba(255,255,255,0.1);
       stroke-width: 8;
     }
     
     #screen-printer .temp-fill {
       fill: none;
       stroke: #22c55e;
       stroke-width: 8;
       stroke-linecap: round;
       stroke-dasharray: 314;
       stroke-dashoffset: 314;
       transition: all 0.5s ease;
       filter: drop-shadow(0 0 8px rgba(34, 197, 94, 0.5));
     }
     
     #screen-printer .temp.heating .temp-fill {
       stroke: #ff6b6b;
       filter: drop-shadow(0 0 12px rgba(255, 107, 107, 0.6));
       animation: heat-glow 2s infinite;
     }
     
     #screen-printer .temp-center {
       position: absolute;
       top: 50%;
       left: 50%;
       transform: translate(-50%, -50%);
       text-align: center;
     }
     
     #screen-printer .temp-actual {
       font-size: 18px;
       font-weight: bold;
       color: #e4e6f1;
       line-height: 1;
     }
     
     #screen-printer .temp-unit {
       font-size: 10px;
       color: #aab2c5;
       margin-top: 2px;
     }
     
     #screen-printer .temp-target {
       font-size: 11px;
       color: #aab2c5;
       text-align: center;
     }
     
     /* Enhanced Speed */
     #screen-printer .speed-container {
       background: rgba(255,255,255,0.02);
       border-radius: 12px;
       padding: 16px;
       border: 1px solid rgba(255,255,255,0.05);
       position: relative;
       overflow: hidden;
       min-height: 0; /* Prevent overflow */
     }
     
     #screen-printer .speed-container::before {
       content: 'üéõÔ∏è';
       position: absolute;
       top: 8px;
       right: 8px;
       font-size: 16px;
       opacity: 0.6;
       animation: control-bounce 2s infinite;
     }
     
     #screen-printer .speed-header {
       display: flex;
       align-items: center;
       gap: 8px;
       margin-bottom: 12px;
     }
     
     #screen-printer .speed-icon {
       font-size: 18px;
       animation: speed-pulse 1.5s infinite;
     }
     
     #screen-printer .speed-label {
       font-size: 14px;
       font-weight: 600;
       color: #e4e6f1;
       flex: 1;
     }
     
     #screen-printer .speed-display {
       font-size: 16px;
       font-weight: bold;
       color: #22c55e;
       padding: 4px 8px;
       background: rgba(34, 197, 94, 0.1);
       border-radius: 8px;
       min-width: 50px;
       text-align: center;
       transition: all 0.3s ease;
     }
     
     #screen-printer .speed-control {
       display: flex;
       flex-direction: column;
       gap: 8px;
     }
     
     #screen-printer .speed-slider-container {
       position: relative;
       height: 60px;
       display: flex;
       align-items: center;
       padding: 10px 0;
     }
     
     #screen-printer .speed-slider-container input[type="range"] {
       position: absolute;
       width: 100%;
       height: 100%;
       opacity: 0;
       cursor: pointer;
       z-index: 2;
     }
     
     #screen-printer .speed-track {
       width: 100%;
       height: 12px;
       background: rgba(255,255,255,0.1);
       border-radius: 6px;
       position: relative;
       overflow: visible;
       box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
     }
     
     #screen-printer .speed-fill {
       height: 100%;
       width: 0%;
       background: linear-gradient(90deg, #22c55e, #4ade80);
       border-radius: 6px;
       transition: width 0.3s ease;
       position: relative;
       box-shadow: 0 2px 8px rgba(34, 197, 94, 0.4);
     }
     
     #screen-printer .speed-knob {
       position: absolute;
       width: 32px;
       height: 32px;
       background: linear-gradient(135deg, #22c55e, #4ade80);
       border-radius: 50%;
       top: 50%;
       transform: translate(-50%, -50%);
       cursor: grab;
       z-index: 3;
       box-shadow: 
         0 4px 12px rgba(0,0,0,0.3),
         0 0 0 4px rgba(34, 197, 94, 0.2),
         inset 0 2px 4px rgba(255,255,255,0.3);
       transition: all 0.2s ease;
       border: 2px solid rgba(255,255,255,0.8);
     }
     
     #screen-printer .speed-knob:hover {
       transform: translate(-50%, -50%) scale(1.1);
       box-shadow: 
         0 6px 16px rgba(0,0,0,0.4),
         0 0 0 6px rgba(34, 197, 94, 0.3),
         inset 0 2px 4px rgba(255,255,255,0.3);
     }
     
     #screen-printer .speed-knob:active {
       cursor: grabbing;
       transform: translate(-50%, -50%) scale(1.05);
     }
     
     #screen-printer .speed-knob::before {
       content: '';
       position: absolute;
       top: 50%;
       left: 50%;
       transform: translate(-50%, -50%);
       width: 8px;
       height: 8px;
       background: rgba(255,255,255,0.9);
       border-radius: 50%;
       box-shadow: 0 1px 3px rgba(0,0,0,0.2);
     }
     
     #screen-printer .speed-fill::after {
       content: '';
       position: absolute;
       top: 0;
       left: 0;
       right: 0;
       bottom: 0;
       background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
       animation: speed-shine 2s infinite;
     }
     
     #screen-printer .speed-markers {
       display: flex;
       justify-content: space-between;
       font-size: 10px;
       color: #aab2c5;
     }
     
     #screen-printer .marker {
       opacity: 0.6;
       transition: opacity 0.3s ease;
     }
     
     #screen-printer .marker.active {
       opacity: 1;
       color: #22c55e;
     }
     
     /* Animations */
     @keyframes pulse {
       0%, 100% { transform: scale(1); }
       50% { transform: scale(1.1); }
     }
     
     @keyframes heat-pulse {
       0%, 100% { transform: scale(1); filter: brightness(1); }
       50% { transform: scale(1.2); filter: brightness(1.3); }
     }
     
     @keyframes status-glow {
       0%, 100% { box-shadow: 0 0 5px rgba(34, 197, 94, 0.5); }
       50% { box-shadow: 0 0 15px rgba(34, 197, 94, 0.8); }
     }
     
     @keyframes heat-glow {
       0%, 100% { filter: drop-shadow(0 0 12px rgba(255, 107, 107, 0.6)); }
       50% { filter: drop-shadow(0 0 20px rgba(255, 107, 107, 0.9)); }
     }
     
     @keyframes speed-pulse {
       0%, 100% { transform: scale(1); }
       50% { transform: scale(1.1); }
     }
     
     @keyframes speed-shine {
       0% { transform: translateX(-100%); }
       100% { transform: translateX(100%); }
     }
     
     @keyframes control-bounce {
       0%, 100% { transform: translateY(0); }
       50% { transform: translateY(-3px); }
     }
     
     @keyframes low-filament-flash {
       0%, 100% { 
         border-color: #ef4444;
         box-shadow: 0 0 10px rgba(239, 68, 68, 0.3);
       }
       50% { 
         border-color: #dc2626;
         box-shadow: 0 0 20px rgba(239, 68, 68, 0.6);
       }
     }
     
     @keyframes text-flash {
       0%, 100% { opacity: 1; }
       50% { opacity: 0.5; }
     }
     
     @keyframes warning-bounce {
       0%, 100% { transform: scale(1); }
       50% { transform: scale(1.2); }
     }
    /* Camera */
    #screen-printer .cam-wrap { 
      position:relative; 
      width:100%; 
      height:100%; 
      background:#0f111a; 
      border-radius:8px; 
      overflow:hidden; 
      border:1px solid #1c2030; 
      display:flex; 
      align-items:center; 
      justify-content:center;
    }
    
    /* Fullscreen exit button - only visible when in fullscreen */
    #screen-printer .cam-wrap.fullscreen::after {
      content: "‚úï";
      position: absolute;
      top: 10px;
      right: 10px;
      width: 40px;
      height: 40px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      z-index: 1000;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }
    #screen-printer .cam-wrap img { 
      width:100%; 
      height:100%; 
      object-fit:contain; /* Changed from cover to contain to preserve aspect ratio */
      image-rendering: auto; /* Ensure smooth rendering */
    }
    #screen-printer .cam-status { position:absolute; bottom:4px; right:4px; font-size:10px; background:#1d2233; padding:2px 6px; border-radius:6px; color:#aab2c5; }
    /* Materials + controls */
    #screen-printer .ams { 
      display:flex; 
      flex-direction: row;
      gap:8px; 
      margin-bottom: clamp(12px, 3vh, 24px); 
      flex: 1;
      min-height: 0; /* Prevent overflow */
      overflow: hidden; /* Ensure content fits */
      width: 100%; /* Ensure full width */
    }
    #screen-printer .slot { 
      background:#0f111a; 
      border:1px solid #1c2030; 
      border-radius:8px; 
      padding:12px; 
      display:flex; 
      flex-direction: column;
      gap:8px; 
      align-items:stretch; 
      min-height: 80px;
      transition: all 0.2s ease;
      flex: 1; /* Make all slots equal width */
      min-width: 0; /* Allow shrinking */
      max-width: calc(25% - 6px); /* Ensure equal distribution (25% minus gap) */
    }
    
         #screen-printer .slot:hover {
       border-color: #22c55e;
       transform: translateY(-1px);
     }
    #screen-printer .slot .chip { 
      width: 100%; 
      height: 100%; 
      border-radius: 8px; 
      border: 1px solid #1c2030; 
      display: block; 
      background-size: contain; 
      background-position: center; 
      background-repeat: no-repeat;
      background-color: #1a1d2a; /* fallback */
      min-height: 60px;
      flex: 1;
      position: relative;
      overflow: hidden;
    }
         #screen-printer .slot .meta { 
       font-size: clamp(11px, 1.8vmin, 14px); 
       color:#cfd6e6; 
       line-height:1.2; 
       text-align: center;
       margin-top: 4px;
       transition: all 0.3s ease;
     }
     
     #screen-printer .slot.low-filament {
       border-color: #ef4444 !important;
       animation: low-filament-flash 2s infinite;
     }
     
     #screen-printer .slot.low-filament .meta {
       color: #ef4444;
       font-weight: bold;
       animation: text-flash 1s infinite;
     }
     
     #screen-printer .slot.low-filament::after {
       content: '‚ö†Ô∏è';
       position: absolute;
       top: 8px;
       right: 8px;
       font-size: 16px;
       animation: warning-bounce 1.5s infinite;
     }
    #screen-printer .controls { 
      display:flex; 
      gap:10px; 
      justify-content: space-between;
      margin-top: auto;
    }
    /* Footer */
    #screen-printer .footer { height:36px; padding:6px 8px; display:flex; align-items:center; justify-content:space-between; border-top:1px solid #1c2030; background:#101218; }
    #screen-printer .state-pill { font-size:12px; padding:4px 8px; border-radius:999px; background:#1d2233; color:#aab2c5; }
    #screen-printer .fps { font-size:12px; color:#aab2c5; }
    /* Buttons */
         #screen-printer .btn { 
       background:#22c55e; 
       color:#fff; 
       border:none; 
       padding: clamp(8px, 1.5vh, 12px) clamp(10px, 2vw, 16px); 
       border-radius:8px; 
       font-size: clamp(13px, 2vmin, 16px);
       cursor: pointer;
       transition: all 0.2s ease;
     }
    #screen-printer .btn:active { 
      transform: translateY(1px); 
    }
    #screen-printer .btn:hover {
      filter: brightness(1.1);
    }
         #screen-printer .btn-small { 
       padding: clamp(6px, 1vh, 10px) clamp(8px, 1.5vw, 14px); 
       font-size: clamp(12px, 1.8vmin, 14px); 
       background:#22c55e; 
     }
    #screen-printer .btn-danger { 
      background:#e24c4c; 
    }
    #screen-printer .btn-back { background:#38435f; }
    
    /* Responsive improvements for filament images */
    @media (max-width: 768px) {
      #screen-printer .grid {
        gap: 8px;
        padding: 8px;
      }
      #screen-printer .card {
        padding: 12px;
      }
      #screen-printer .ams {
        gap: 6px;
        width: 100%;
      }
      #screen-printer .slot {
        padding: 6px;
        min-height: 70px;
        flex: 1;
        min-width: 0;
        max-width: calc(25% - 4.5px); /* Adjust for smaller gap */
      }
      #screen-printer .slot .chip {
        min-height: 50px;
      }
      #screen-printer .temp-circle {
        width: 60px;
        height: 60px;
      }
      #screen-printer .speed-slider-container {
        height: 50px;
      }
    }
    
    @media (min-width: 1200px) {
      #screen-printer .ams {
        gap: 12px;
        width: 100%;
      }
      #screen-printer .slot {
        padding: 12px;
        min-height: 100px;
        flex: 1;
        min-width: 0;
        max-width: calc(25% - 9px); /* Adjust for larger gap */
      }
      #screen-printer .slot .chip {
        min-height: 80px;
      }
    }
    
    /* Ensure no scrollbars on any screen size */
    @media (max-height: 600px) {
      #screen-printer .grid {
        gap: 8px;
        padding: 8px;
      }
      #screen-printer .card {
        padding: 12px;
      }
      #screen-printer .temp-circle {
        width: 60px;
        height: 60px;
      }
      #screen-printer .video-container {
        min-height: 150px;
      }
    }
  </style>
  
  <script>
  (function() {
    'use strict';
    const root = document.getElementById('screen-printer');
  
         // UI refs (scoped)
     const progressFill = root.querySelector('#progress-fill');
     const progressPercent = root.querySelector('#progress-percent');
     const nameEl = root.querySelector('#job-name');
     const etaEl = root.querySelector('#eta');
     const layerEl = root.querySelector('#layer');
     
     // Enhanced temperature elements
     const nozAct = root.querySelector('#nozzle-actual');
     const bedAct = root.querySelector('#bed-actual');
     const nozTar = root.querySelector('#nozzle-target');
     const bedTar = root.querySelector('#bed-target');
     const nozStatus = root.querySelector('#nozzle-status');
     const bedStatus = root.querySelector('#bed-status');
     const nozCircle = root.querySelector('#nozzle-circle');
     const bedCircle = root.querySelector('#bed-circle');
     const nozTemp = root.querySelector('.nozzle-temp');
     const bedTemp = root.querySelector('.bed-temp');
     
     // Enhanced speed elements
     const speedRange = root.querySelector('#speed');
     const speedDisplay = root.querySelector('#speed-display');
     const speedFill = root.querySelector('#speed-fill');
     const speedKnob = root.querySelector('#speed-knob');
     const speedMarkers = root.querySelectorAll('.marker');
     
     const statePill = root.querySelector('#state-pill');
     const fpsEl = root.querySelector('#fps');
     const netDot = root.querySelector('.net-dot');
     const cam = root.querySelector('#cam');
     const camStatus = root.querySelector('#cam-status');
  
    // AMS slots
    const slotEls = Array.from(root.querySelectorAll('.slot'));
  
    // Constants
    // No longer needed - using simple percentage for progress slider
  
    // Local state
    let uiState = null;
    let rafId = 0;
    let lastFrameTs = 0;
    let frames = 0;
    let fpsTimer = 0;
    let online = true;
    let worker = null;
    let listeners = [];
    let currentCamUrl = '';
  
    // Inline Web Worker via Blob, to keep file self-contained
    function makeWorker() {
      const code = `
        let state = {
          phase: "idle",
          job: null,
          temps: { nozzle: 25, bed: 25, tNozzle: 0, tBed: 0 },
          speed: { multiplier: 100 },
                     materials: { slots: [
             { id:"A1", type:"Yellow", color:"#f9c74f", grams:230, active:true },
             { id:"A2", type:"Blue", color:"#577590", grams:180, active:false },
             { id:"A3", type:"Green", color:"#90be6d", grams:150, active:false },
             { id:"A4", type:"Tort", color:"#f97f29", grams:10, active:false }
           ]},
          camera: { url:"", online:false },
          ts: Date.now()
        };
        let tickMs = 200;
        let layerTimeMs = 4000; // base per layer at 100%
        let layersTotal = 120;
        let heatingPhase = 0;
        let timer = 0;
  
        function startJob(name) {
          state.phase = "heating";
          state.temps.tNozzle = 210;
          state.temps.tBed = 60;
          state.job = { name, progress:0, layer:0, layers:layersTotal, etaSec: layersTotal * layerTimeMs / 1000 };
          heatingPhase = 0;
          post();
        }
  
        function pause() {
          if (state.phase === "printing") state.phase = "paused";
          post();
        }
  
        function resume() {
          if (state.phase === "paused") state.phase = "printing";
          post();
        }
  
        function cancel() {
          state.phase = "cooling";
          post();
        }
  
        function setSpeed(mult) {
          state.speed.multiplier = mult;
          post();
        }
  
        function filamentOut() {
          state.phase = "paused";
          postMessage({ banner: "Filament runout detected. Replace and resume." });
          post();
        }
  
        function tempFault() {
          state.phase = "error";
          postMessage({ banner: "Temperature fault. Check heater/thermistor." });
          post();
        }
  
        function heatToward(target, actual) {
          const d = target - actual;
          return actual + Math.sign(d) * Math.min(Math.abs(d), 4);
        }
  
        function coolToward(target, actual) {
          const d = target - actual;
          return actual + Math.sign(d) * Math.min(Math.abs(d), 2);
        }
  
        function post() { state.ts = Date.now(); postMessage({ type: "state", state }); }
  
        function loop() {
          timer = setTimeout(loop, tickMs);
          // temps
          if (state.phase === "heating" || state.phase === "printing") {
            state.temps.nozzle = heatToward(state.temps.tNozzle, state.temps.nozzle);
            state.temps.bed = heatToward(state.temps.tBed, state.temps.bed);
          } else {
            state.temps.nozzle = coolToward(25, state.temps.nozzle);
            state.temps.bed = coolToward(25, state.temps.bed);
          }
  
          // phases
          if (state.phase === "heating") {
            heatingPhase += tickMs;
            const ready = Math.abs(state.temps.nozzle - state.temps.tNozzle) < 2 && Math.abs(state.temps.bed - state.temps.tBed) < 2;
            if (ready || heatingPhase > 5000) state.phase = "homing";
          } else if (state.phase === "homing") {
            // brief homing then print
            heatingPhase += tickMs;
            if (heatingPhase > 7000) state.phase = "printing";
          } else if (state.phase === "printing") {
            const mult = state.speed.multiplier / 100;
            const effectiveLayerMs = layerTimeMs / mult;
            // advance progress
            if (!state._acc) state._acc = 0;
            state._acc += tickMs;
            while (state._acc >= effectiveLayerMs) {
              state._acc -= effectiveLayerMs;
              state.job.layer = Math.min(state.job.layer + 1, state.job.layers);
            }
            state.job.progress = Math.round((state.job.layer / state.job.layers) * 100);
            const remainingLayers = state.job.layers - state.job.layer;
            state.job.etaSec = Math.max(0, Math.round(remainingLayers * effectiveLayerMs / 1000));
            if (state.job.layer >= state.job.layers) state.phase = "cooling";
          } else if (state.phase === "cooling") {
            const coolDone = state.temps.nozzle <= 30 && state.temps.bed <= 30;
            if (coolDone) { state.phase = "complete"; }
          }
          post();
        }
  
        onmessage = (e) => {
          const { type, data } = e.data || {};
          if (type === "cmd") {
            if (data === "start") startJob("Gearbox_cover_v7.gcode");
            else if (data === "pause") pause();
            else if (data === "resume") resume();
            else if (data === "cancel") cancel();
            else if (data && data.speed) setSpeed(data.speed);
            else if (data === "filament-out") filamentOut();
            else if (data === "temp-fault") tempFault();
          } else if (type === "lifecycle") {
            if (data === "start") { loop(); }
            else if (data === "stop") { clearTimeout(timer); }
            else if (data === "terminate") { clearTimeout(timer); close(); }
          }
        };
        post(); // initial
      `;
      const blob = new Blob([code], { type: 'application/javascript' });
      return new Worker(URL.createObjectURL(blob));
    }
  
    // UI helpers
    function fmtETA(sec) {
      if (sec == null) return 'ETA ‚Äî';
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `ETA ${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }
  
    function setProgress(pct) {
      const clamped = Math.max(0, Math.min(100, pct || 0));
      progressFill.style.width = `${clamped}%`;
      progressPercent.textContent = `${Math.round(clamped)}%`;
    }
  
         function applyTemps(noz, nozT, bed, bedT) {
       // Update actual temperatures
       nozAct.textContent = Math.round(noz);
       bedAct.textContent = Math.round(bed);
       nozTar.textContent = Math.round(nozT);
       bedTar.textContent = Math.round(bedT);
       
       // Calculate percentages for circular progress
       const nzPercent = Math.min(100, Math.max(0, (nozT ? noz / nozT : 0) * 100));
       const bdPercent = Math.min(100, Math.max(0, (bedT ? bed / bedT : 0) * 100));
       
       // Update circular progress (stroke-dashoffset)
       const circumference = 314; // 2 * œÄ * 50
       nozCircle.style.strokeDashoffset = circumference - (nzPercent / 100) * circumference;
       bedCircle.style.strokeDashoffset = circumference - (bdPercent / 100) * circumference;
       
       // Update status and heating animations
       updateTempStatus(nozTemp, noz, nozT, nozStatus, nozCircle);
       updateTempStatus(bedTemp, bed, bedT, bedStatus, bedCircle);
       
       // Dynamic colors based on temperature
       const nozzleColor = getTempColor(noz, 25, 250);
       const bedColor = getTempColor(bed, 25, 120);
       
       nozCircle.style.stroke = nozzleColor;
       bedCircle.style.stroke = bedColor;
     }
     
     function updateTempStatus(tempEl, actual, target, statusEl, circleEl) {
       const isHeating = actual < target - 2;
       const isHot = actual > target * 0.8;
       
       // Update status text
       if (isHeating) {
         statusEl.textContent = 'Heating';
         tempEl.classList.add('heating');
       } else if (isHot) {
         statusEl.textContent = 'Hot';
         tempEl.classList.remove('heating');
         tempEl.classList.add('hot');
       } else {
         statusEl.textContent = 'Ready';
         tempEl.classList.remove('heating', 'hot');
       }
       
       // Add glow effect for hot temperatures
       if (actual > target * 0.9) {
         circleEl.style.filter = `drop-shadow(0 0 15px ${getTempColor(actual, 25, 250)})`;
       } else {
         circleEl.style.filter = '';
       }
     }
    
    function getTempColor(temp, minTemp, maxTemp) {
      // Clamp temperature between min and max
      const clamped = Math.max(minTemp, Math.min(maxTemp, temp));
      // Calculate percentage (0 = cold/blue, 1 = hot/red)
      const percent = (clamped - minTemp) / (maxTemp - minTemp);
      
      // Interpolate between blue and red
      const blue = Math.round(226 - (percent * 226)); // 226 to 0
      const red = Math.round(107 + (percent * 148));  // 107 to 255
      const green = Math.round(74 + (percent * 97));  // 74 to 171
      
      return `rgb(${red}, ${green}, ${blue})`;
    }
  
    function applyAMS(slots) {
      function pickFilamentImageFromType(typeText) {
        const t = String(typeText || '').toUpperCase();
        if (t.includes('YELLOW')) return '../assets/yellow.png';
        if (t.includes('ORANGE')) return '../assets/tort.png';
        if (t.includes('BLUE')) return '../assets/blue.png';
        if (t.includes('GREEN')) return '../assets/green.png';
        if (t.includes('SILVER')) return '../assets/tort.png';
        return '';
      }

      function pickFilamentImageFromColor(hex) {
        if (!hex || typeof hex !== 'string' || !hex.startsWith('#') || (hex.length !== 7 && hex.length !== 4)) return '';
        // Normalize 3-digit hex to 6-digit
        let h = hex.toLowerCase();
        if (h.length === 4) h = `#${h[1]}${h[1]}${h[2]}${h[2]}${h[3]}${h[3]}`;
        const r = parseInt(h.slice(1,3), 16);
        const g = parseInt(h.slice(3,5), 16);
        const b = parseInt(h.slice(5,7), 16);
        // Very simple rules
        const isYellow = r > 200 && g > 180 && b < 120;
        const isOrange = r > 200 && g >= 80 && g < 180 && b < 120;
        const isBlue = b > 140 && r < 140;
        const isGreen = g > 140 && r < 140 && b < 140;
        const isSilver = Math.abs(r-g) < 20 && Math.abs(g-b) < 20 && r > 120; // near gray
        if (isYellow) return '../assets/yellow.png';
        if (isOrange) return '../assets/tort.png';
        if (isBlue) return '../assets/blue.png';
        if (isGreen) return '../assets/green.png';
        if (isSilver) return '../assets/tort.png';
        return '';
      }

      slots.slice(0,4).forEach((s, i) => {
        const el = slotEls[i];
        if (!el) return;

        const chipEl = el.querySelector('.chip');
        // Prefer explicit type keywords, else infer from color
        let img = pickFilamentImageFromType(s.type);
        if (!img) img = pickFilamentImageFromColor(s.color);

        if (img) {
          chipEl.style.backgroundImage = `url(${img})`;
          chipEl.style.backgroundColor = '#1a1d2a';
        } else {
          chipEl.style.backgroundImage = '';
          chipEl.style.background = s.color || '#666';
        }

                          // Check for low filament and apply warning effects
         const isLowFilament = s.grams <= 20;
         const metaText = isLowFilament ? 'Filament Low' : `${s.grams} g${s.active ? ' ‚Ä¢ Active' : ''}`;
         el.querySelector('.meta').textContent = metaText;
         
         // Apply low filament warning styling
         if (isLowFilament) {
           el.classList.add('low-filament');
         } else {
           el.classList.remove('low-filament');
         }
         
         // Keep active outline
         el.style.outline = s.active ? '2px solid #22c55e' : 'none';
      });
    }
  
    function setStatePill(phase) {
      statePill.textContent = phase.charAt(0).toUpperCase() + phase.slice(1);
    }
  
    function setNetworkDot(isOnline) {
      online = isOnline;
      netDot.classList.toggle('online', online);
    }
  
    function setCamera(url, isOnline) {
      camStatus.textContent = isOnline ? 'Live' : 'Camera offline';
      if (isOnline && url) {
        // Only set once to avoid restarting the GIF on each state update
        if (currentCamUrl !== url) {
          cam.src = url;
          currentCamUrl = url;
        }
        // Set attributes once (idempotent)
        if (!cam.hasAttribute('loading')) cam.setAttribute('loading', 'eager');
        if (!cam.hasAttribute('decoding')) cam.setAttribute('decoding', 'sync');
      } else {
        if (currentCamUrl) {
          cam.removeAttribute('src');
          currentCamUrl = '';
        }
      }
    }
  
    function handleBanner(msg) {
      if (!msg) return;
      // Very light inline banner
      const b = document.createElement('div');
      b.textContent = msg;
      b.style.position = 'absolute';
      b.style.left = '8px';
      b.style.right = '8px';
      b.style.top = '8px';
      b.style.padding = '8px';
      b.style.borderRadius = '8px';
      b.style.background = '#e8a317';
      b.style.color = '#111';
      b.style.fontSize = '12px';
      b.style.zIndex = '10';
      root.appendChild(b);
      setTimeout(() => b.remove(), 2500);
    }
  
    // Animation loop for tiny UI effects and FPS
    function frame(ts) {
      frames++;
      if (!lastFrameTs) lastFrameTs = ts;
      if (ts - lastFrameTs >= 1000) {
        fpsEl.textContent = `FPS ${frames}`;
        frames = 0;
        lastFrameTs = ts;
      }
      rafId = requestAnimationFrame(frame);
    }
  
    // Event wiring (scoped)
    function on(el, ev, fn) {
      el.addEventListener(ev, fn, { passive: true });
      listeners.push(() => el.removeEventListener(ev, fn));
    }
  
    // Lifecycle
    function activate() {
      // Start or resume worker and UI loop
      if (!worker) worker = makeWorker();
      worker.onmessage = (e) => {
        if (e.data && e.data.type === 'state') {
          uiState = e.data.state;
          // Map to UI
          const s = uiState;
          setStatePill(s.phase);
          setProgress(s.job ? s.job.progress : 0);
          nameEl.textContent = s.job ? s.job.name : 'No job';
          etaEl.textContent = s.job ? fmtETA(s.job.etaSec) : 'ETA ‚Äî';
          layerEl.textContent = s.job ? `Layer ${s.job.layer}/${s.job.layers}` : 'Layer ‚Äî';
          applyTemps(s.temps.nozzle, s.temps.tNozzle, s.temps.bed, s.temps.tBed);
          applyAMS(s.materials.slots);
          setNetworkDot(window.navigator.onLine);
          // Camera demo: if on LAN, set your stream URL here; otherwise offline
          setCamera('../assets/3d.gif', true);


        } else if (e.data && e.data.banner) {
          handleBanner(e.data.banner);
        }
      };
      worker.postMessage({ type: 'lifecycle', data: 'start' });
      rafId = requestAnimationFrame(frame);
    }
  
    function deactivate() {
      if (worker) worker.postMessage({ type: 'lifecycle', data: 'stop' });
      if (rafId) cancelAnimationFrame(rafId);
      rafId = 0;
    }
  
    function cleanup() {
      deactivate();
      if (worker) {
        worker.postMessage({ type: 'lifecycle', data: 'terminate' });
        worker.terminate();
        worker = null;
      }
      listeners.forEach(off => off());
      listeners = [];
    }
  
    // Home button
    const homeButton = root.querySelector('#btnHome');
    if (homeButton) {
      on(homeButton, 'click', function() {
        window.location.href = '../index.html';
      });
    }
    
    // Controls
    on(root, 'click', (e) => {
      const t = e.target;
      if (!(t instanceof Element)) return;
      const action = t.getAttribute('data-action');
      if (action === 'pause') worker && worker.postMessage({ type: 'cmd', data: 'pause' });
      else if (action === 'resume') worker && worker.postMessage({ type: 'cmd', data: 'resume' });
      else if (action === 'cancel') worker && worker.postMessage({ type: 'cmd', data: 'cancel' });
      // Demo injections
      const demo = t.getAttribute('data-demo');
      if (demo === 'filament-out') worker && worker.postMessage({ type: 'cmd', data: 'filament-out' });
      else if (demo === 'temp-fault') worker && worker.postMessage({ type: 'cmd', data: 'temp-fault' });
      else if (demo === 'new-job') worker && worker.postMessage({ type: 'cmd', data: 'start' });
    });
  
         // Enhanced speed slider with drag functionality
     let isDragging = false;
     let startX = 0;
     let startLeft = 0;
     
     // Function to update slider value and visual elements
     function updateSliderValue(value) {
       // Clamp value between min and max
       const clampedValue = Math.max(50, Math.min(150, value));
       
       // Update the range input
       speedRange.value = clampedValue;
       
       // Update display
       speedDisplay.textContent = `${clampedValue}%`;
       
       // Calculate fill width and knob position
       const percentage = ((clampedValue - 50) / 100) * 100;
       speedFill.style.width = `${percentage}%`;
       
       // Position the knob
       speedKnob.style.left = `${percentage}%`;
       
       // Update active marker
       speedMarkers.forEach(marker => marker.classList.remove('active'));
       if (clampedValue <= 75) {
         speedMarkers[0].classList.add('active');
       } else if (clampedValue <= 125) {
         speedMarkers[1].classList.add('active');
       } else {
         speedMarkers[2].classList.add('active');
       }
       
       // Send to worker
       worker && worker.postMessage({ type: 'cmd', data: { speed: clampedValue } });
     }
     
     // Mouse events for dragging
     on(speedKnob, 'mousedown', (e) => {
       e.preventDefault();
       isDragging = true;
       startX = e.clientX;
       startLeft = parseFloat(speedKnob.style.left) || 0;
       
       // Add dragging visual feedback
       speedKnob.style.transform = 'translate(-50%, -50%) scale(1.05)';
       speedKnob.style.cursor = 'grabbing';
     });
     
     on(document, 'mousemove', (e) => {
       if (!isDragging) return;
       
       const deltaX = e.clientX - startX;
       const trackWidth = speedRange.offsetWidth;
       const percentageChange = (deltaX / trackWidth) * 100;
       const newPercentage = Math.max(0, Math.min(100, startLeft + percentageChange));
       
       // Calculate new value based on percentage
       const newValue = 50 + (newPercentage / 100) * 100;
       updateSliderValue(newValue);
     });
     
     on(document, 'mouseup', () => {
       if (isDragging) {
         isDragging = false;
         speedKnob.style.transform = 'translate(-50%, -50%) scale(1)';
         speedKnob.style.cursor = 'grab';
       }
     });
     
     // Touch events for mobile dragging
     on(speedKnob, 'touchstart', (e) => {
       e.preventDefault();
       isDragging = true;
       startX = e.touches[0].clientX;
       startLeft = parseFloat(speedKnob.style.left) || 0;
       
       // Add dragging visual feedback
       speedKnob.style.transform = 'translate(-50%, -50%) scale(1.05)';
       speedKnob.style.cursor = 'grabbing';
     });
     
     on(document, 'touchmove', (e) => {
       if (!isDragging) return;
       e.preventDefault();
       
       const deltaX = e.touches[0].clientX - startX;
       const trackWidth = speedRange.offsetWidth;
       const percentageChange = (deltaX / trackWidth) * 100;
       const newPercentage = Math.max(0, Math.min(100, startLeft + percentageChange));
       
       // Calculate new value based on percentage
       const newValue = 50 + (newPercentage / 100) * 100;
       updateSliderValue(newValue);
     });
     
     on(document, 'touchend', () => {
       if (isDragging) {
         isDragging = false;
         speedKnob.style.transform = 'translate(-50%, -50%) scale(1)';
         speedKnob.style.cursor = 'grab';
       }
     });
     
     // Keep the original input event for when user clicks on the track
     on(speedRange, 'input', () => {
       const v = Number(speedRange.value);
       updateSliderValue(v);
       
       // Add visual feedback for track clicks
       speedKnob.style.transform = 'translate(-50%, -50%) scale(1.1)';
       setTimeout(() => {
         speedKnob.style.transform = 'translate(-50%, -50%) scale(1)';
       }, 150);
     });
     
     // Initialize knob position
     setTimeout(() => {
       const initialValue = Number(speedRange.value);
       updateSliderValue(initialValue);
     }, 100);
  
    // Camera fullscreen
    const camBtn = root.querySelector('#cam-fullscreen');
    const camWrap = root.querySelector('.cam-wrap');
    
    on(camBtn, 'click', () => {
      if (camWrap.requestFullscreen) {
        camWrap.requestFullscreen().then(() => {
          // Add fullscreen class for styling
          camWrap.classList.add('fullscreen');
        }).catch(err => {
          console.log('Fullscreen failed:', err);
        });
      }
    });
    
    // Handle fullscreen exit
    on(document, 'fullscreenchange', () => {
      if (!document.fullscreenElement) {
        // Remove fullscreen class when exiting
        camWrap.classList.remove('fullscreen');
      }
    });
    
    // Touch-friendly exit button (click on the X button)
    on(camWrap, 'click', (e) => {
      // Check if we're in fullscreen and clicked on the exit button area
      if (document.fullscreenElement && camWrap.classList.contains('fullscreen')) {
        const rect = camWrap.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        // Check if click is in the top-right corner (where the X button is)
        if (x > rect.width - 60 && y < 60) {
          if (document.exitFullscreen) {
            document.exitFullscreen();
          }
        }
      }
    });
  
    // Online/offline indicators
    on(window, 'online', () => setNetworkDot(true));
    on(window, 'offline', () => setNetworkDot(false));
  
    // Export required lifecycle in the expected shape
    window.appLifecycle = {
      activate,
      deactivate,
      cleanup
    };
  
    // Auto-init: start UI and immediately begin job simulation
    // If your framework calls activate/deactivate, remove this auto-activation.
    // For standalone testing:
    if (!window.showcaseFramework) {
      activate();
      // Start the job automatically after a short delay to allow UI to initialize
      setTimeout(() => {
        if (worker) {
          worker.postMessage({ type: 'cmd', data: 'start' });
        }
      }, 500);
    }
  })();
  </script>
